Перем мМакетныйОбъект;
Перем мТекущаяГруппаТипаМетаданных;
Перем мСоответствиеСтрокДереваИМетаданных;
Перем мВыборкаРезультата;
Перем мРезультатЗапроса;
Перем мВыбранныеУзлы;
Перем мМетаданныеПланаОбмена;
Перем мДанныеПоКоличествуИзменений;
Перем мВнутреннееИмяТаблицы;
Перем мИменаПлановОбмена;
Перем мИмяПоляОбъектУдален;
Перем мСоставыПлановОбмена;
Перем мПометкиУзлов;
Перем мМоментЗапускаЗадания;
Перем мДлительностьСбораСтатистики;

Функция СохраняемаяНастройкаФормы(выхНаименование, выхИменаСвойств) Экспорт 
	выхИменаСвойств = "Реквизит.ИмяПланОбмена, Форма.ОтображатьТолькоМетаданныеСИзменениями,
	|Форма.ОтображатьТолькоТаблицыСАвторегистрацией, Форма.ИзменятьРегистрациюСДвижениями, Форма.ДвиженияВместеСПоследовательностями";
	Если мПометкиУзлов = Неопределено Тогда
		СоздатьТаблицуПометок();
	КонецЕсли;
	ОбновитьСохраняемыеПометкиУзлов();
	Результат = Новый Структура("ПометкиУзлов", мПометкиУзлов);
	Результат.Вставить("ВычислятьЧислоЗарегистрированныхИзменений", Истина
		И ВычислятьЧислоЗарегистрированныхИзменений
		И Ложь
			Или ирОбщий.ЛиАсинхронностьДоступнаЛкс() И мДлительностьСбораСтатистики < 6 
			Или мДлительностьСбораСтатистики < 3);
	Возврат Результат;
КонецФункции

Процедура ЗагрузитьНастройкуВФорме(НастройкаФормы, ДопПараметры) Экспорт 
	
	ирКлиент.ЗагрузитьНастройкуФормыЛкс(ЭтаФорма, НастройкаФормы); 
	НастройкаФормы.Свойство("ПометкиУзлов", мПометкиУзлов); 
	Если мПометкиУзлов = Неопределено Тогда
		СоздатьТаблицуПометок();
	КонецЕсли;
	
	Если Открыта() И Не ЗначениеЗаполнено(ПараметрУзелОбмена) Тогда
		//ПланОбменаПриИзмененииБезВычисленияКоличества();
		//
		ПланОбменаПриИзменении();
	КонецЕсли; 

КонецПроцедуры

Процедура СоздатьТаблицуПометок()
	
	мПометкиУзлов = Узлы.СкопироватьКолонки("Пометка, ПланОбмена, Ссылка");

КонецПроцедуры

Процедура ОбновитьКоличествоДляСтрокиДерева(СтрокаДерева = Неопределено)
	
	Если СтрокаДерева = Неопределено Тогда
		СтрокаДерева = ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока;
	КонецЕсли; 
	КолонкиКоличества = Новый Массив();
	КолонкиКоличества.Добавить("КоличествоЗарегистрированных");
	КолонкиКоличества.Добавить("КоличествоВыгруженных");
	КолонкиКоличества.Добавить("КоличествоНевыгруженных");
	Для Каждого ИмяКолонкиКоличества Из КолонкиКоличества Цикл
		СтароеКоличество = СтрокаДерева[ИмяКолонкиКоличества];
		СтрокаДерева[ИмяКолонкиКоличества] = 0;
		Для Каждого ЭлементПакета Из мДанныеПоКоличествуИзменений Цикл
			СтрокиРезультата = ЭлементПакета.НайтиСтроки(Новый Структура("ПолноеИмя", СтрокаДерева.ПолноеИмя));
			Для Каждого СтрокаРезультата Из СтрокиРезультата Цикл
				Если мВыбранныеУзлы.Найти(СтрокаРезультата.Узел) = Неопределено Тогда
					Продолжить;
				КонецЕсли; 
				СтрокаДерева[ИмяКолонкиКоличества] = СтрокаДерева[ИмяКолонкиКоличества] + СтрокаРезультата[ИмяКолонкиКоличества];
			КонецЦикла;
		КонецЦикла;
		Родитель = СтрокаДерева.Родитель;
		Пока Родитель <> Неопределено Цикл
			Родитель[ИмяКолонкиКоличества] = Родитель[ИмяКолонкиКоличества] - СтароеКоличество + СтрокаДерева[ИмяКолонкиКоличества];
			Родитель = Родитель.Родитель;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПостроитьДеревоОбменаДанных(ДеревоТаблиц, ПринудительноВыполнитьЗапрос = Ложь, Перезапустить = Истина)
	
	ДеревоТаблиц.Строки.Очистить();
	мСоответствиеСтрокДереваИМетаданных.Очистить();
	//Если мМетаданныеПланаОбмена = Неопределено Тогда
	//	Возврат;
	//КонецЕсли; 
	ТаблицаВсехТаблиц = ирКэш.ТаблицаВсехТаблицБДЛкс();
	СтрокиМетаОбъектов = ирКэш.Получить().ТаблицаТиповМетаОбъектов.НайтиСтроки(Новый Структура("Категория", 0));
	ИндикаторТипов = ирОбщий.ПолучитьИндикаторПроцессаЛкс(СтрокиМетаОбъектов.Количество(), "Типы метаданных");
	Для Каждого ТипМетаОбъектов Из СтрокиМетаОбъектов Цикл
		ирОбщий.ОбработатьИндикаторЛкс(ИндикаторТипов);
		Единственное = ТипМетаОбъектов.Единственное;
		Если Ложь
			Или Единственное = "КритерийОтбора"
			Или Единственное = "ЖурналДокументов"
			Или Единственное = "ВнешнийИсточникДанных"
		Тогда
			Продолжить;
		КонецЕсли;
		СтрокаТипаМД = ДеревоТаблиц.Строки.Добавить();
		СтрокаТипаМД.Имя = ТипМетаОбъектов.Единственное;
		СтрокаТипаМД.Представление = ирОбщий.ПредставлениеИзИдентификатораЛкс(ТипМетаОбъектов.Множественное);
		СтрокаТипаМД.ПолноеИмя = ТипМетаОбъектов.Единственное;
		СтрокаТипаМД.ЕстьДоступ = Истина;
		СтруктураДанных = Новый Структура();
		СтруктураДанных.Вставить("ОписаниеТипа", ТипМетаОбъектов);
		СтруктураДанных.Вставить("СтрокаДерева", СтрокаТипаМД);
		мСоответствиеСтрокДереваИМетаданных[ТипМетаОбъектов.Единственное] = СтруктураДанных;
		Если Единственное = "Перерасчет" Тогда
			КоллекцияПредков = Метаданные.РегистрыРасчета;
		Иначе
			КоллекцияПредков = Новый Массив;
			КоллекцияПредков.Добавить(Метаданные);
		КонецЕсли; 
		Для Каждого МетаданныеОбъектаПредка Из КоллекцияПредков Цикл
			//ИндикаторОбъекта = ирОбщий.ПолучитьИндикаторПроцессаЛкс(МетаданныеОбъектаПредка[ТипМетаОбъектов.Множественное].Количество(), ТипМетаОбъектов.Множественное);
			Для Каждого ОбъектМД Из МетаданныеОбъектаПредка[ТипМетаОбъектов.Множественное] Цикл
				//ирОбщий.ОбработатьИндикаторЛкс(ИндикаторОбъекта); //Отключено для ускорения. Даже в ERP каждая коллекция предков выполняется меньше 1 сек
				ОбработкаПрерыванияПользователя();
				ПолноеИмяМД = ОбъектМД.ПолноеИмя();
				Если ЗначениеЗаполнено(ИмяПланОбмена) Тогда
					ЭлементСостава = мСоставыПлановОбмена[ИмяПланОбмена].Найти(ОбъектМД);
					Если Ложь
						Или ЭлементСостава = Неопределено
						Или (Истина
							И ОтображатьТолькоТаблицыСАвторегистрацией
							И ЭлементСостава.Авторегистрация <> АвтоРегистрацияИзменений.Разрешить)
					Тогда
						Продолжить;
					КонецЕсли; 
				Иначе
					ИмяТаблицыИзменений = ирКэш.ИмяТаблицыИзМетаданныхЛкс(ПолноеИмяМД, Истина, Ложь);
					//ОписаниеТаблицыИзменений = ТаблицаВсехТаблиц.НайтиСтроки(Новый Структура("НПолноеИмя, Тип", НРег(ИмяТаблицыИзменений), "Изменения"));
					ОписаниеТаблицыИзменений = ТаблицаВсехТаблиц.НайтиСтроки(Новый Структура("НПолноеИмя", НРег(ИмяТаблицыИзменений)));
					Если ОписаниеТаблицыИзменений.Количество() = 0 Тогда
						Продолжить;
					КонецЕсли; 
				КонецЕсли; 
				ИмяТаблицыБД = ирКэш.ИмяТаблицыИзМетаданныхЛкс(ПолноеИмяМД, , Ложь);
				ОписаниеТаблицы = ирОбщий.ОписаниеТаблицыБДЛкс(ИмяТаблицыБД);
				Если ИмяТаблицыБД = "Константы" Тогда
					// Для 8.2.13 и ниже
					ИмяТаблицыБД = ПолноеИмяМД;
					ОписаниеТаблицы = ирОбщий.СтруктураИзСтрокиТаблицыИлиДереваИлиВыборкиЛкс(ОписаниеТаблицы);
					ОписаниеТаблицы.Имя = ОбъектМД.Имя;
					ОписаниеТаблицы.Представление = ОбъектМД.Представление();
					ОписаниеТаблицы.Тип = "Константа";
					ОписаниеТаблицы.ЕстьДоступ = Истина;
				КонецЕсли; 
				//ЭлементСоответствия = мСоответствиеСтрокДереваИМетаданных[ОписаниеТаблицы.Тип];
				//Если ЭлементСоответствия = Неопределено Тогда
				//	//СообщитьОшибкуИис("Невозможно определить тип объекта: " + Строка(МетаданныеОбъекта));
				//	Продолжить;
				//КонецЕсли;
				//СтрокаДерева = ЭлементСоответствия.СтрокаДерева;
				СтрокаОбъектаМД = СтрокаТипаМД.Строки.Добавить(); 
				СтрокаОбъектаМД.Имя = ОписаниеТаблицы.Имя;
				СтрокаОбъектаМД.Представление = ОписаниеТаблицы.Представление;
				СтрокаОбъектаМД.ПолноеИмя = ИмяТаблицыБД;
				СтрокаОбъектаМД.КоличествоЗарегистрированных = 0;
				СтрокаОбъектаМД.ЕстьДоступ = ОписаниеТаблицы.ЕстьДоступ;
				Если Не СтрокаОбъектаМД.ЕстьДоступ Тогда
					СтрокаТипаМД.ЕстьДоступ = Ложь;
				КонецЕсли;
				Для Каждого ИмяПланаОбменаЦикл Из мИменаПлановОбмена Цикл
					ЭлементСостава = мСоставыПлановОбмена[ИмяПланаОбменаЦикл].Найти(ОбъектМД);
					Если ЭлементСостава <> Неопределено Тогда
						СтрокаОбъектаМД["Авторегистрация_" + ИмяПланаОбменаЦикл] = ЭлементСостава.АвтоРегистрация = АвтоРегистрацияИзменений.Разрешить;
					КонецЕсли;
				КонецЦикла; 
			КонецЦикла;
			//ирОбщий.ОсвободитьИндикаторПроцессаЛкс();
		КонецЦикла;
	КонецЦикла;
	ирОбщий.ОсвободитьИндикаторПроцессаЛкс();
	ОбъектМД = Неопределено;
	СтрокиКУдалению = ирОбщий.ОтобратьКоллекциюЛкс(ДеревоТаблиц.Строки, "Э.Строки.Количество() = 0");
	Для Каждого СтрокаКУдалению Из СтрокиКУдалению Цикл
		ДеревоТаблиц.Строки.Удалить(СтрокаКУдалению);
	КонецЦикла;
	Если ВычислятьЧислоЗарегистрированныхИзменений Тогда
		ОбновитьСтатистикуВСоставеПланаОбмена(, ПринудительноВыполнитьЗапрос, Перезапустить);
	КонецЕсли;
	    	
КонецПроцедуры

Процедура ОбновитьСтатистикуВСоставеПланаОбмена(РазрешитьАсинхронно = Истина, ПринудительноВыполнитьЗапрос = Ложь, Перезапустить = Истина)

	Если Не ВычислятьЧислоЗарегистрированныхИзменений Тогда
		Возврат;
	КонецЕсли; 
	РазрешитьУдалениеСтрок = Истина;
	Если ПринудительноВыполнитьЗапрос Или мДанныеПоКоличествуИзменений = Неопределено Тогда
		СтруктураОтбора = Неопределено;
		Если ЗначениеЗаполнено(ИмяПланОбмена) Тогда
			СтруктураОтбора = Новый Структура("_ТипУзла_", Тип("ПланОбменаСсылка." + ИмяПланОбмена));
		КонецЕсли;
		мМоментЗапускаЗадания = ТекущаяДата();
		#Если Сервер И Не Сервер Тогда
			ОбновитьСтатистикуЗавершение();
		#КонецЕсли
		РезультатВычисления = ирОбщий.ВычислитьКоличествоСтрокТаблицВДеревеМетаданныхЛкс(ДеревоТаблиц, "ПолноеИмя", "КоличествоЗарегистрированных", Истина, 
			//Новый Структура("Узел", Узлы.ВыгрузитьКолонку("Ссылка"))
			СтруктураОтбора,,, ЭтаФорма, ЭлементыФормы.КоманднаяПанельДереваОбъектов.Кнопки.Обновить, "ОбновитьСтатистикуЗавершение", РазрешитьАсинхронно, Перезапустить);
		РазрешитьУдалениеСтрок = РезультатВычисления <> Неопределено;
	КонецЕсли; 
	ПерезаполнитьКолонкиКоличества(РазрешитьУдалениеСтрок);

КонецПроцедуры

Процедура ПерезаполнитьКолонкиКоличества(РазрешитьУдалениеСтрок = Истина)
	
	ОбновитьИтогиПоУзлам();
	Если мДанныеПоКоличествуИзменений <> Неопределено Тогда
		ирКлиент.ЗаполнитьКоличествоСтрокТаблицВДеревеМетаданныхЛкс(ДеревоТаблиц, мДанныеПоКоличествуИзменений, "ПолноеИмя", "КоличествоЗарегистрированных, КоличествоНевыгруженных, КоличествоВыгруженных",
			Новый Структура("Узел", мВыбранныеУзлы));
	КонецЕсли; 
	Если РазрешитьУдалениеСтрок И ОтображатьТолькоМетаданныеСИзменениями Тогда
		СтрокиКУдалению = Новый Массив();
		Для Каждого СтрокаДерева1 Из ДеревоТаблиц.Строки Цикл
			Для Каждого СтрокаДерева2 Из СтрокаДерева1.Строки Цикл
				Если Истина
					И ОтображатьТолькоМетаданныеСИзменениями 
					И СтрокаДерева2.КоличествоЗарегистрированных = 0
				Тогда
					СтрокиКУдалению.Добавить(СтрокаДерева2);
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;
		Для Каждого СтрокаКУдалению Из СтрокиКУдалению Цикл
			СтрокаКУдалению.Родитель.Строки.Удалить(СтрокаКУдалению);
		КонецЦикла;
		СтрокиКУдалению = Новый Массив();
		Для Каждого СтрокаДерева1 Из ДеревоТаблиц.Строки Цикл
			Если СтрокаДерева1.Строки.Количество() = 0 Тогда
				СтрокиКУдалению.Добавить(СтрокаДерева1);
			КонецЕсли;
		КонецЦикла;
		Для Каждого СтрокаКУдалению Из СтрокиКУдалению Цикл
			ДеревоТаблиц.Строки.Удалить(СтрокаКУдалению);
		КонецЦикла;
	КонецЕсли; 
	ирКлиент.ТабличноеПолеОбновитьТекстыПодваловЛкс(ЭтаФорма, ЭлементыФормы.ДеревоТаблиц);

КонецПроцедуры

Процедура ОбновитьИтогиПоУзлам()

	Для Каждого СтрокаУзла Из Узлы Цикл
		СтрокаУзла.КоличествоЗарегистрированных = 0;
		СтрокаУзла.КоличествоНевыгруженных = 0;
		СтрокаУзла.КоличествоВыгруженных = 0;
	КонецЦикла; 
	Если мДанныеПоКоличествуИзменений <> Неопределено Тогда
		Для Каждого ТаблицаРезультата Из мДанныеПоКоличествуИзменений Цикл
			Для Каждого СтрокаРезультата Из ТаблицаРезультата Цикл
				СтрокаУзла = Узлы.Найти(СтрокаРезультата.Узел, "Ссылка");
				Если СтрокаУзла = Неопределено Тогда
					СтрокаУзла = Узлы.Добавить();
					СтрокаУзла.Ссылка = СтрокаРезультата.Узел;
					ЗаполнитьСтрокуУзла(СтрокаУзла);
				КонецЕсли; 
				СтрокаУзла.КоличествоЗарегистрированных = СтрокаУзла.КоличествоЗарегистрированных + СтрокаРезультата.КоличествоЗарегистрированных;
				СтрокаУзла.КоличествоНевыгруженных = СтрокаУзла.КоличествоНевыгруженных + СтрокаРезультата.КоличествоНевыгруженных;
				СтрокаУзла.КоличествоВыгруженных = СтрокаУзла.КоличествоВыгруженных + СтрокаРезультата.КоличествоВыгруженных;
			КонецЦикла;
		КонецЦикла; 
	КонецЕсли; 

КонецПроцедуры

//Функция по имени родителя предка формируется префикс типа
Функция СформироватьПрефиксТипаСсылки(Знач НаименованиеПредка)
	
	Если НаименованиеПредка = "Справочники" Тогда
		Возврат "СправочникСсылка";
	ИначеЕсли НаименованиеПредка = "Документы" Тогда
		Возврат "ДокументСсылка";
	ИначеЕсли НаименованиеПредка = "ПланыВидовХарактеристик" Тогда
		Возврат "ПланВидовХарактеристикСсылка";
	ИначеЕсли НаименованиеПредка = "ПланыСчетов" Тогда
		Возврат "ПланСчетовСсылка";
	ИначеЕсли НаименованиеПредка = "ПланыВидовРасчета" Тогда
		Возврат "ПланВидовРасчетаСсылка";
	ИначеЕсли НаименованиеПредка = "БизнесПроцессы" Тогда
		Возврат "БизнесПроцессСсылка";
	ИначеЕсли НаименованиеПредка = "Задачи" Тогда
		Возврат "ЗадачаСсылка";
	Иначе
		Возврат "";
	КонецЕсли;
	
КонецФункции

//процедура строит дерево измененных объектов для узла
Процедура ПостроитьДеревоСоставаПланаОбмена(ПринудительноВыполнитьЗапрос = Ложь, Перезапустить = Истина)
	
	СостояниеСтрокДерева = ирКлиент.ТабличноеПолеСостояниеСтрокЛкс(ЭлементыФормы.ДеревоТаблиц, "ПолноеИмя");
	ДеревоТаблиц.Строки.Очистить(); 
	ОбновитьВидимостьКолонокАвторегистрации();
	ПостроитьДеревоОбменаДанных(ДеревоТаблиц, ПринудительноВыполнитьЗапрос, Перезапустить);
	ДеревоТаблиц.Строки.Сортировать("Имя", Истина);
	ирКлиент.ТабличноеПолеВосстановитьСостояниеСтрокЛкс(ЭлементыФормы.ДеревоТаблиц, СостояниеСтрокДерева);
	Если ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока = Неопределено Тогда
		КП_ТаблицаИзмененийОбновить();
	КонецЕсли; 
	
КонецПроцедуры

//процедура добавляет/удаляет регистрацию для объектов
Процедура ДобавитьУдалитьРегистрациюДляВыбранныхОбъектовМД(Знач НовоеЗначение = Истина)
	
	КоличествоВыбранныхОбъектовМД = ЭлементыФормы.ДеревоТаблиц.ВыделенныеСтроки.Количество();
	Если КоличествоВыбранныхОбъектовМД = 0 Тогда
		ирОбщий.СообщитьЛкс("Необходимо выделить строки типов");
		Возврат;
	КонецЕсли; 
	РегистрацияВсехИзменений = Истина;
	НужноОбновлятьДерево = НовоеЗначение;
	СтрокаДобавленияУдаленияРегистрации = ?(НовоеЗначение, "Добавить", "Удалить");
	ВыбранныеСтрокиДерева = ПолучитьВыбранныеСтрокиДерева();
	Если КоличествоВыбранныхОбъектовМД = 1 Тогда
		УровеньВыбраннойСтроки = ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные.Уровень();
		СписокРедактирования = Неопределено;
		Если УровеньВыбраннойСтроки = 0 Тогда
			// общий класс, справочники, константы...
			ТекстПодтверждения = СтрокаДобавленияУдаленияРегистрации + " регистрацию для всех объектов с типом: " + ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные.Имя;
			ОтветПользователя = Вопрос(ТекстПодтверждения, РежимДиалогаВопрос.ДаНет);
			Если ОтветПользователя <> КодВозвратаДиалога.Да Тогда
				Возврат;
			КонецЕсли;
		ИначеЕсли УровеньВыбраннойСтроки = 1 Тогда
			// конкретный справочник или константа
			Если ирОбщий.СтрокиРавныЛкс(ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные.Родитель.ПолноеИмя, "Константы") Тогда
				РегистрацияВсехИзменений = Истина;
			Иначе
				ТекстПодтверждения = СтрокаДобавленияУдаленияРегистрации + " регистрацию для всех (Да) или выборочных (Нет) объектов с типом: " + ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные.Имя;
				ОтветПользователя = Вопрос(ТекстПодтверждения, РежимДиалогаВопрос.ДаНетОтмена, , КодВозвратаДиалога.Нет);
				Если ОтветПользователя = КодВозвратаДиалога.Отмена Тогда
					Возврат;
				ИначеЕсли ОтветПользователя = КодВозвратаДиалога.Да Тогда
					РегистрацияВсехИзменений = Истина;
				ИначеЕсли ОтветПользователя = КодВозвратаДиалога.Нет Тогда
					РегистрацияВсехИзменений = Ложь;
					СписокРедактирования = ПолучитьДанныеДляРегистрацииИзменений(ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные.ПолноеИмя);
					Если СписокРедактирования = Неопределено Тогда
						Возврат;
					КонецЕсли;
					НужноОбновлятьДерево = Истина;
				КонецЕсли;
			КонецЕсли; 
		КонецЕсли;
	Иначе
		ТекстПодтверждения = СтрокаДобавленияУдаленияРегистрации + " регистрацию для всех объектов всех (" + ВыбранныеСтрокиДерева.Количество() + ") выделенных типов?";
		ОтветПользователя = Вопрос(ТекстПодтверждения, РежимДиалогаВопрос.ДаНет);
		Если ОтветПользователя <> КодВозвратаДиалога.Да Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	Если НовоеЗначение Тогда
		Комментарий = "Добавление";
	Иначе
		Комментарий = "Удаление";
	КонецЕсли; 
	Комментарий = Комментарий + " регистрации выбранных типов данных. " + ПредставлениеВыбранныхУзлов;
	ЗаписьЖурналаРегистрации("Изменение регистрации данных", УровеньЖурналаРегистрации.Предупреждение, мМетаданныеПланаОбмена,, Комментарий);
	Индикатор = ирОбщий.ПолучитьИндикаторПроцессаЛкс(ВыбранныеСтрокиДерева.Количество());
	Для Каждого СтрокаДерева Из ВыбранныеСтрокиДерева Цикл
		ирОбщий.ОбработатьИндикаторЛкс(Индикатор);
		Если СтрокаДерева = Неопределено Тогда
			Продолжить;
		КонецЕсли; 
		Если РегистрацияВсехИзменений Тогда
			ИзменитьРегистрациюЦелойТаблицы(СтрокаДерева, НовоеЗначение);
		Иначе
			// регистрация того, что выберет пользователь
			СтрокаОбновления = ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные;
			//Если СтрокаОбновления.Уровень() >= 2 Тогда
			//	СтрокаОбновления = СтрокаОбновления.Родитель;
			//КонецЕсли;
			ОбъектМД = ирКэш.ОбъектМДПоПолномуИмениЛкс(ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные.ПолноеИмя);
			УзлыДляРегистрации = ирОбщий.ПолучитьРазрешенныеУзлыДляОбъектаМДЛкс(ОбъектМД, мВыбранныеУзлы);
			Для Каждого ЗначенияСписка Из СписокРедактирования Цикл
				Успех = ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, ЗначенияСписка.Значение, НовоеЗначение, ИзменятьРегистрациюСДвижениями, ДвиженияВместеСПоследовательностями);
				//Если Истина
				//	И Успех 
				//	И Не ДобавитьРегистрацию 
				//	И Не НужноОбновлятьДерево 
				//Тогда
				//	ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные.Родитель.Строки.Удалить(ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные);
				//КонецЕсли;
			КонецЦикла;
			ОбновитьИтогиПоТаблице(СтрокаДерева);
		КонецЕсли; 
	КонецЦикла;
	ирОбщий.ОсвободитьИндикаторПроцессаЛкс(Индикатор);
	Если НужноОбновлятьДерево Тогда
		ПостроитьДеревоСоставаПланаОбмена();
	Иначе
		КП_ТаблицаИзмененийОбновить();
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьВыбранныеСтрокиДерева(СтрокиДерева = Неопределено, Результат = Неопределено)
	
	Если Результат = Неопределено Тогда
		Результат = Новый Массив;
	КонецЕсли; 
	Если СтрокиДерева = Неопределено Тогда
		СтрокиДерева = ЭлементыФормы.ДеревоТаблиц.ВыделенныеСтроки;
	КонецЕсли; 
	Для Каждого ВыбраннаяСтрока Из СтрокиДерева Цикл
		Если ВыбраннаяСтрока = Неопределено Тогда
			Продолжить;
		КонецЕсли; 
		УровеньВыбраннойСтроки = ВыбраннаяСтрока.Уровень();
		Если УровеньВыбраннойСтроки = 0 Тогда
			ПолучитьВыбранныеСтрокиДерева(ВыбраннаяСтрока.Строки, Результат);
		Иначе
			Если Результат.Найти(ВыбраннаяСтрока) = Неопределено Тогда
				Результат.Добавить(ВыбраннаяСтрока);
			КонецЕсли; 
		КонецЕсли; 
	КонецЦикла;
	Возврат Результат;
	
КонецФункции

Функция ПолучитьПолныеИменаВыделенныхТаблиц(СтрокиДерева = Неопределено, Результат = Неопределено)
	
	ВсеВыделенныеСтроки = ПолучитьВыбранныеСтрокиДерева();
	Результат = Новый СписокЗначений;
	Для Каждого ВыделеннаяСтрока Из ВсеВыделенныеСтроки Цикл
		Результат.Добавить(ВыделеннаяСтрока.ПолноеИмя);
	КонецЦикла;
	Результат.СортироватьПоЗначению();
	Возврат Результат;
	
КонецФункции

Функция ИзменитьРегистрациюЦелойТаблицы(СтрокаДерева, НовоеЗначениеРегистрации)

	ОбъектМеданных = ирОбщий.ОбъектМДПоПолномуИмениТаблицыБДЛкс(СтрокаДерева.ПолноеИмя);
	Успех = ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(мВыбранныеУзлы, ОбъектМеданных, НовоеЗначениеРегистрации, ИзменятьРегистрациюСДвижениями, ДвиженияВместеСПоследовательностями,, Истина);
	//Если Успех И Не ДобавитьРегистрацию Тогда
	//	УдалитьКонечныеЭлементыДерева(ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные);
	//КонецЕсли;
	Если ИзменятьРегистрациюСДвижениями Тогда
		ПодключитьОбработчикОжидания("ЗаказатьОбновлениеДереваПослеИзмененияРегистрации", 0.1, Истина);
	Иначе
		ОбновитьИтогиПоТаблице(СтрокаДерева);
	КонецЕсли; 
	Возврат Неопределено;

КонецФункции

// для узла обмена показывает зарегистрированные изменения
Процедура КоманднаяПанельДереваОбъектовОбновить(Кнопка)
	
	ОбновитьКоличествоВДереве(Истина, Ложь);
		
КонецПроцедуры

Процедура ЗаказатьОбновлениеДереваПослеИзмененияРегистрации()
	
	ОбновитьКоличествоВДереве(Истина);

КонецПроцедуры

Функция ПолучитьИндексКартинкиПоМетаданным(УровеньДерева, ДанныеСтроки)
	
	Если УровеньДерева = 0 Тогда
		СтрокаСоответствия = мСоответствиеСтрокДереваИМетаданных[ДанныеСтроки.Имя];
		Возврат СтрокаСоответствия.ОписаниеТипа.ИндексКартинкиМножественное;
	ИначеЕсли УровеньДерева = 1 Тогда
		СтрокаСоответствия = мСоответствиеСтрокДереваИМетаданных[ДанныеСтроки.Родитель.Имя];
		Возврат СтрокаСоответствия.ОписаниеТипа.ИндексКартинкиЕдинственное;
	КонецЕсли;
	
КонецФункции

// при выводе строки дерева
Процедура ДеревоОбменаПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки) Экспорт
	
	ирКлиент.ТабличноеПолеПриВыводеСтрокиЛкс(ЭтаФорма, Элемент, ОформлениеСтроки, ДанныеСтроки);
	УровеньДерева = ДанныеСтроки.Уровень();
	ОформлениеСтроки.Ячейки.Имя.ОтображатьКартинку = истина;
	ОформлениеСтроки.Ячейки.Имя.ИндексКартинки = ПолучитьИндексКартинкиПоМетаданным(УровеньДерева, ДанныеСтроки);
	Если ДанныеСтроки.ЕстьДоступ = Ложь Тогда 
		ОформлениеСтроки.ЦветТекста = WebЦвета.Красный;
	КонецЕсли; 
	Для Каждого лИмяПланаОбмена Из мИменаПлановОбмена Цикл
		ИмяКолонки = "Авторегистрация_" + лИмяПланаОбмена;
		Ячейка = ОформлениеСтроки.Ячейки[ИмяКолонки];
		Ячейка.ОтображатьКартинку = Ложь;
		Ячейка.Текст = "";
		Если УровеньДерева = 1 Тогда
			Если ДанныеСтроки[ИмяКолонки] = Истина Тогда
				Ячейка.ИндексКартинки = 0;
				Ячейка.ОтображатьКартинку = Истина;
				Ячейка.Текст = "Разрешить";
			ИначеЕсли ДанныеСтроки[ИмяКолонки] = Ложь Тогда
				Ячейка.ИндексКартинки = 1;
				Ячейка.ОтображатьКартинку = Истина;
				Ячейка.Текст = "Запретить";
			Иначе
				Ячейка.ОтображатьКартинку = Ложь;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла; 
	
КонецПроцедуры

// развернуть дерево
Процедура КоманднаяПанельДереваОбъектовРазвернуть(Кнопка)
	
	Если ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЭлементыФормы.ДеревоТаблиц.Развернуть(ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные, Истина);
	
КонецПроцедуры

// выбор строки дерева
Процедура ДеревоОбменаВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	Если ВыбраннаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	УровеньВыбраннойСтроки = ВыбраннаяСтрока.Уровень();
	
	Если УровеньВыбраннойСтроки < 1 Тогда
		Элемент.Развернуть(ВыбраннаяСтрока);
		Возврат;
	КонецЕсли;
	Если УровеньВыбраннойСтроки = 1 Тогда
		ОбновитьИтогиПоТаблице();
	КонецЕсли;
	
КонецПроцедуры

//Процедура удаляет все строки дерева у которых уровень не меньше 2
Процедура УдалитьКонечныеЭлементыДерева(ДеревоДанных)
	
	Если ДеревоДанных.Уровень() >= 1 Тогда
		
		ДеревоДанных.Строки.Очистить();
		
	Иначе
		
		Для Каждого СтрокаДерева Из ДеревоДанных.Строки Цикл
			
			УдалитьКонечныеЭлементыДерева(СтрокаДерева);
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

// удаление регистрации изменений
Процедура КоманднаяПанельДереваОбъектовОтменитьРегистрациюИзменения(Кнопка)
	
	ДобавитьУдалитьРегистрациюДляВыбранныхОбъектовМД(Ложь);
		
КонецПроцедуры

//Функция возвращает данные для регистрации изменений
Функция ПолучитьДанныеДляРегистрацииИзменений(ПолноеИмяМД)
	
	// не для всех типов позволяем список объектов для регистрации редактировать
	Если мТекущаяГруппаТипаМетаданных = "Ссылочный" Тогда
		МассивТипов = Новый Массив();
		МассивТипов.Добавить(Тип(ирОбщий.ИмяТипаИзПолногоИмениТаблицыБДЛкс(ПолноеИмяМД)));
		СписокРедактирования = Новый СписокЗначений;
		СписокРедактирования.ТипЗначения = Новый ОписаниеТипов(МассивТипов);
		РезультатФормы = ирКлиент.ОткрытьЗначениеЛкс(СписокРедактирования, Истина,,,, Истина);
		Если РезультатФормы <> Истина Тогда
			Возврат Неопределено;
		КонецЕсли;
		// Избавляемся от пустых ссылок, т.к. они приводят к глобальной регистрации всех данных
		НачальноеКоличество = СписокРедактирования.Количество(); 
		Для СчетчикСписокРедактирования = 1 По НачальноеКоличество Цикл
			ЭлементСписка = СписокРедактирования[НачальноеКоличество - СчетчикСписокРедактирования];
			Если Не ЗначениеЗаполнено(ЭлементСписка.Значение) Тогда
				СписокРедактирования.Удалить(ЭлементСписка);
			КонецЕсли;
		КонецЦикла;
		
		// ничего не выбрали для регистрации
		Если СписокРедактирования.Количество() = 0 Тогда 
			Возврат Неопределено;
		КонецЕсли;
		
	КонецЕсли;

	Возврат СписокРедактирования;
	
КонецФункции

// добавить регистрацию
Процедура КоманднаяПанельДереваОбъектовДобавитьРегистрацию(Кнопка)
	
	ДобавитьУдалитьРегистрациюДляВыбранныхОбъектовМД(Истина);
	
КонецПроцедуры

//Функция регистрирует изменнения для всего дерева объектов
Функция ИзменитьРегистрациюИзмененийНаВыбранныхУзлахДляВсегоСоставаПланаОбмена(НовоеЗначение = Истина)
	
	Если мВыбранныеУзлы.Количество() = 0 Тогда
		Предупреждение("Сначала необходимо выбрать узлы");
		Возврат Ложь;
	КонецЕсли; 
	ФормаВопроса = ПолучитьФорму("ФормаВыбораОбновленияРегистрации", ЭтаФорма);
	Если НовоеЗначение Тогда
		ФормаВопроса.ТекстВопросаПользователю = "Операция регистрации всех изменений необратима, Вы уверены, "
			+ "что хотите зарегистрировать изменения для выбранных узлов для ВСЕХ объектов, типы которых входят в план обмена?";
		Комментарий = "Добавление";
	Иначе
		ФормаВопроса.ТекстВопросаПользователю = "Операция удаления регистрации изменений необратима, Вы уверены, "
			+ "что хотите удалить регистрацию изменений для выбранных узлов для ВСЕХ объектов, типы которых входят в план обмена?";
		Комментарий = "Удаление";
	КонецЕсли; 
	РезультатОткрытия = ФормаВопроса.ОткрытьМодально();
	Если РезультатОткрытия <> Истина Тогда
		Возврат Ложь;
	КонецЕсли;
	мДанныеПоКоличествуИзменений = Неопределено;
	ТолькоДляОбъектовСАвтоматическойРегистрацией = ФормаВопроса.ОбновлятьТолькоДляЭлементовСАвтоРегистрацией;
	Если ТолькоДляОбъектовСАвтоматическойРегистрацией Тогда
		Комментарий = Комментарий + " регистрации всех авторегистрируемых типов данных";
	Иначе
		Комментарий = Комментарий + " регистрации всех типов данных";
	КонецЕсли; 
	Комментарий = Комментарий + ". " + ПредставлениеВыбранныхУзлов;
	ЗаписьЖурналаРегистрации("Изменение регистрации данных", УровеньЖурналаРегистрации.Предупреждение, мМетаданныеПланаОбмена,, Комментарий);
	Если НовоеЗначение Тогда
		Действие = "ЗарегистрироватьВсе";
	Иначе
		Действие = "УдалитьРегистрациюВсех";
	КонецЕсли; 
	ОбработатьВсеОбъектыМД(Действие, ТолькоДляОбъектовСАвтоматическойРегистрацией);
	Возврат Истина;
	
КонецФункции

// Похожа на ПолучитьКлючСтрокиТаблицыБДИзСтрокиТаблицыЗначенийЛкс
Функция ПолучитьОбъектДанныхПоСтрокеИзменений(СтрокаДанных = Неопределено)
	
	Если СтрокаДанных = Неопределено Тогда
		СтрокаДанных = ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока;
	КонецЕсли; 
	Если СтрокаДанных = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли; 
	Если мТекущаяГруппаТипаМетаданных = "Ссылочный" Тогда
		//Объект = СтрокаДанных.Ссылка.ПолучитьОбъект();
		СтруктураОбъекта = ирОбщий.ОбъектБДПоКлючуЛкс(, СтрокаДанных.Ссылка);
		Если СтруктураОбъекта.Методы.ЭтоНовый() Тогда
			СтруктураОбъекта = Новый УдалениеОбъекта(СтрокаДанных.Ссылка);
		КонецЕсли; 
	ИначеЕсли мТекущаяГруппаТипаМетаданных = "Регистр" Тогда
		СтруктураОбъекта = мМакетныйОбъект;
		ЗаполнитьОтборМакетногоОбъекта(СтрокаДанных);
		СтруктураОбъекта.Методы.Прочитать();
	ИначеЕсли мТекущаяГруппаТипаМетаданных = "Константа" Тогда
		СтруктураОбъекта = мМакетныйОбъект;
		СтруктураОбъекта.Методы.Прочитать();
	КонецЕсли;
	Возврат СтруктураОбъекта;
	
КонецФункции

Процедура ЗаполнитьОтборМакетногоОбъекта(Знач СтрокаДанных)
	
	// Антибаг 8.2.15 http://www.partners.v8.1c.ru/forum/thread.jsp?id=1034617#1034617
	//Объект.Отбор.Сбросить();
	//мМакетныйОбъект.Методы.Отбор.Сбросить();
	Для Каждого Колонка Из ТаблицаИзменений.Колонки Цикл
		ЭлементОтбора = мМакетныйОбъект.Методы.Отбор.Найти(Колонка.Имя);
		Если ЭлементОтбора = Неопределено Тогда
			Продолжить;
		КонецЕсли; 
		ирОбщий.ПрисвоитьЕслиНеРавноЛкс(ЭлементОтбора.Использование, Истина);
		ЭлементОтбора.Значение = СтрокаДанных[Колонка.Имя];
	КонецЦикла;

КонецПроцедуры

// показываем результат стандарной выгрузки
Процедура КоманднаяПанельДереваОбъектовПоказатьРезультатСтандартнойВыгрузки(Кнопка)
	
	Если ЭлементыФормы.ТаблицаИзменений.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку("UTF-16");
	СтруктураОбъекта = ПолучитьОбъектДанныхПоСтрокеИзменений();
	Если СтруктураОбъекта = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	Попытка
		ирОбщий.ОбъектВСтрокуXMLЛкс(СтруктураОбъекта.Методы, Ложь,,, ЗаписьXML);
	Исключение
		ирОбщий.СообщитьЛкс(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	СтрXML = ЗаписьXML.Закрыть();
	ирКлиент.ОткрытьТекстЛкс(СтрXML, "XML представление объекта """ + ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока.ПолноеИмя + """", "XML", Истина, ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока);
	
КонецПроцедуры

Процедура ВыполнитьРегистрациюПервыхОбъектовДляУзла(ОбъектМД, УзлыДляРегистрации, КоличествоОбъектовКаждогоТипа = 1)
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ Первые " + XMLСтрока(КоличествоОбъектовКаждогоТипа) + "
	               |	" + мВнутреннееИмяТаблицы + ".Ссылка
	               |ИЗ
	               |	" + ОбъектМД.ПолноеИмя() + " КАК " + мВнутреннееИмяТаблицы;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ОбработкаПрерыванияПользователя();
		ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, Выборка.Ссылка, Истина, ИзменятьРегистрациюСДвижениями, ДвиженияВместеСПоследовательностями);
	КонецЦикла;
	
КонецПроцедуры

Процедура ВыполнитьРегистрациюРегистра(Знач ТипТаблицы, Знач ПолноеИмяТаблицы, УзлыДляРегистрации, КоличествоОбъектовКаждогоТипа = 1,
	ТолькоУзлыСАвторегистрацией = Ложь)
	
	КолонкаОтбора = "Регистратор";
	Если ТипТаблицы = "Перерасчет" Тогда
		КолонкаОтбора = "ОбъектПерерасчета";
	ИначеЕсли ТипТаблицы = "РегистрСведений" Тогда
		МетаданныеРегистра = ирОбщий.ОбъектМДПоПолномуИмениТаблицыБДЛкс(ПолноеИмяТаблицы);
		Если МетаданныеРегистра.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.Независимый Тогда
			КолонкаОтбора = "";
			МассивКолонокОтбора = Новый Массив();
			Если МетаданныеРегистра.ПериодичностьРегистраСведений <> Метаданные.СвойстваОбъектов.ПериодичностьРегистраСведений.Непериодический Тогда
				МассивКолонокОтбора.Добавить("Период");		
			КонецЕсли;
			Для Каждого КолонкаИзмерений Из МетаданныеРегистра.Измерения Цикл
				Если КолонкаИзмерений.ОсновнойОтбор = Истина Тогда
					МассивКолонокОтбора.Добавить(КолонкаИзмерений.Имя);	
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;		
	
	Запрос = Новый Запрос();
	СтрокаКолонокВыборкиДанных = "";
	Если КолонкаОтбора <> "" Тогда
		СтрокаКолонокВыборкиДанных = мВнутреннееИмяТаблицы + "." + КолонкаОтбора;
	Иначе
		Для Каждого ЭлементКолонки Из МассивКолонокОтбора Цикл
			СтрокаКолонокВыборкиДанных = СтрокаКолонокВыборкиДанных + "," + Символы.ПС + мВнутреннееИмяТаблицы + "." + ЭлементКолонки;
		КонецЦикла;
		СтрокаКолонокВыборкиДанных = СокрЛП(Сред(СтрокаКолонокВыборкиДанных, 2));
	КонецЕсли;
	
	// нет ни измерений, ни периодичности
	Если ПустаяСтрока(СтрокаКолонокВыборкиДанных) Тогда
		ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, МетаданныеРегистра, Истина, ИзменятьРегистрациюСДвижениями, ДвиженияВместеСПоследовательностями);
		Возврат;
	КонецЕсли;
	
	Запрос.Текст = "ВЫБРАТЬ Первые " + XMLСтрока(КоличествоОбъектовКаждогоТипа) + "
				   |	" + СтрокаКолонокВыборкиДанных + " 
				   |ИЗ
				   |	" + ПолноеИмяТаблицы + " КАК " + мВнутреннееИмяТаблицы;
				   
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл 
		СтруктураНаборЗаписей = ирОбщий.СоздатьНаборЗаписейПоИмениТаблицыБДЛкс(ПолноеИмяТаблицы);
		Если КолонкаОтбора <> "" Тогда 
			СтруктураНаборЗаписей.Методы.Отбор[КолонкаОтбора].Установить(Выборка[КолонкаОтбора]);
		Иначе
			Для Каждого ЭлементКолонки Из МассивКолонокОтбора Цикл
				СтруктураНаборЗаписей.Методы.Отбор[ЭлементКолонки].Установить(Выборка[ЭлементКолонки]);
			КонецЦикла;
		КонецЕсли;
		ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, СтруктураНаборЗаписей.Методы, Истина, ИзменятьРегистрациюСДвижениями, ДвиженияВместеСПоследовательностями);
	КонецЦикла;
	
КонецПроцедуры

Функция _ВыбратьУзелОбменаПоМетаданным()
	
	лИмяПланаОбмена = мМетаданныеПланаОбмена.Имя;
	Запрос = Новый запрос();
	Запрос.Текст = "ВЫБРАТЬ первые 2
	               |	ПланОбменаРезультат.Ссылка
	               |ИЗ
	               |	ПланОбмена." + лИмяПланаОбмена + " КАК ПланОбменаРезультат
	               |ГДЕ
	               |	ПланОбменаРезультат.ПометкаУдаления = Ложь
	               |	И ПланОбменаРезультат.Ссылка <> &ТекущийУзелОбмена";
	Запрос.УстановитьПараметр("ТекущийУзелОбмена", ПланыОбмена[лИмяПланаОбмена].ЭтотУзел());
	ТаблицаРезультата = Запрос.Выполнить().Выгрузить();
	Если ТаблицаРезультата.Количество() = 1 Тогда
		Возврат ТаблицаРезультата[0].Ссылка;
	Иначе
		Возврат ПланыОбмена[лИмяПланаОбмена].ПустаяСсылка();
	КонецЕсли;
	
КонецФункции

Процедура ПланОбменаПриИзменении(Элемент = Неопределено) Экспорт
	
	//Если Элемент <> Неопределено Тогда
	//	// Антибаг платформы 8.2.16 http://partners.v8.1c.ru/forum/thread.jsp?id=1077270#1077270
	//	Элемент.Значение = Элемент.Значение;
	//КонецЕсли; 
	Если Элемент = Неопределено Тогда
		Элемент = ЭлементыФормы.ИмяПланОбмена;
	КонецЕсли; 
	ТаблицаИзменений.Очистить();
	ДеревоТаблиц.Строки.Очистить();
	мМетаданныеПланаОбмена = Метаданные.ПланыОбмена.Найти(ИмяПланОбмена);
	Если мМетаданныеПланаОбмена = Неопределено Тогда
		Элемент.Значение = Неопределено;
	КонецЕсли; 
	мДанныеПоКоличествуИзменений = Неопределено;
	ЭтаФорма.РИБ = Ложь;
	Если мМетаданныеПланаОбмена <> Неопределено Тогда
		ЭтаФорма.РИБ = мМетаданныеПланаОбмена.РаспределеннаяИнформационнаяБаза;
	КонецЕсли; 
	КПУзлыОбновить(, Истина);
	КП_ТаблицаИзмененийОбновить();
	//ПроверитьЗаполнитьИтогиТаблицыПоУзлам();
	ирКлиент.ПолеВводаСИсториейВыбора_ПриИзмененииЛкс(Элемент, ЭтаФорма);
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	ирКлиент.Форма_ПриОткрытииЛкс(ЭтаФорма);
	ирКлиент.СоздатьМенеджерСохраненияНастроекФормыЛкс(ЭтаФорма);
	Если ЗначениеЗаполнено(ПараметрУзелОбмена) Тогда
		ЭтаФорма.ИмяПланОбмена = ПараметрУзелОбмена.Метаданные().Имя;
		мВыбранныеУзлы.Добавить(ПараметрУзелОбмена);
		ПланОбменаПриИзменении();
	Иначе
		Если Узлы.Количество() = 0 Тогда
			ПланОбменаПриИзмененииБезВычисленияКоличества();
		КонецЕсли;
	КонецЕсли; 
	КлючПоиска = Новый Структура;
	Если ЗначениеЗаполнено(ПараметрУзелОбмена) Тогда
		СтрокаУзла = Узлы.Найти(ПараметрУзелОбмена, "Ссылка");
		Если СтрокаУзла <> Неопределено Тогда
			ЭлементыФормы.Узлы.ТекущаяСтрока = СтрокаУзла;
		КонецЕсли; 
		КлючПоиска.Вставить("Узел", ПараметрУзелОбмена);
		ПараметрУзелОбмена = Неопределено;
	КонецЕсли; 
	Если ПараметрОбъект <> Неопределено Тогда
		СтрокаТипа = ДеревоТаблиц.Строки.Найти(Метаданные.НайтиПоТипу(ирОбщий.ТипОбъектаБДЛкс(ПараметрОбъект)).ПолноеИмя(), "ПолноеИмя", Истина);
		Если СтрокаТипа <> Неопределено Тогда
			ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока = СтрокаТипа;
			Если ирОбщий.ЛиКорневойТипСсылочногоОбъектаБДЛкс(СтрокаТипа.Родитель.Имя) Тогда
				КлючПоиска.Вставить("Ссылка", ПараметрОбъект.Ссылка);
				СтрокиИзменений = ТаблицаИзменений.НайтиСтроки(КлючПоиска);
				Если СтрокиИзменений.Количество() > 0 Тогда
					ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока = СтрокиИзменений[0];
				КонецЕсли;
			КонецЕсли;
		КонецЕсли; 
	КонецЕсли; 
	Если ирОбщий.РежимСовместимостиМеньше8_3_4Лкс() Тогда
		ЭлементыФормы.Узлы.Колонки.ЭтотУзел.Видимость = Ложь;
		ЭлементыФормы.Узлы.Колонки.ЭтотУзел.ИзменятьВидимость = Ложь;
	КонецЕсли; 
		
КонецПроцедуры

Процедура УдалитьРегистрациюДляВсехОбъектовНажатие(Элемент)
	
	ИзменитьРегистрациюИзмененийНаВыбранныхУзлахДляВсегоСоставаПланаОбмена(Ложь);
	
КонецПроцедуры

Процедура ЗарегистрироватьИзмененияДляВсехОбъектовНажатие(Элемент)
	
	ИзменитьРегистрациюИзмененийНаВыбранныхУзлахДляВсегоСоставаПланаОбмена(Истина);
	
КонецПроцедуры

Процедура ЗарегистрироватьИзмененияПоОдномуОбъектуНажатие(Элемент)
	
	Если мВыбранныеУзлы.Количество() = 0 Тогда
		Предупреждение("Сначала необходимо выбрать узлы");
		Возврат;
	КонецЕсли; 
	КоличествоОбъектовКаждогоТипа = 1;
	Если Не ВвестиЗначение(КоличествоОбъектовКаждогоТипа, "Введите количество объектов каждого типа", Тип("Число")) Тогда 
		Возврат;
	КонецЕсли; 
	ФормаВопроса = ПолучитьФорму("ФормаВыбораОбновленияРегистрации", ЭтаФорма);
	ФормаВопроса.ТекстВопросаПользователю = "Операция регистрации одного изменения для каждого типа объектов необратима, Вы уверены, что хотите зарегистрировать изменения?";
	РезультатОткрытия = ФормаВопроса.ОткрытьМодально();
	Если РезультатОткрытия <> Истина Тогда
		Возврат;
	КонецЕсли;
	ОбработатьВсеОбъектыМД("ЗарегистироватьПервыеN", ФормаВопроса.ОбновлятьТолькоДляЭлементовСАвтоРегистрацией, КоличествоОбъектовКаждогоТипа);
		
КонецПроцедуры

Процедура ОбработатьВсеОбъектыМД(Действие, ТолькоДляОбъектовСАвтоматическойРегистрацией = Ложь, КоличествоОбъектовКаждогоТипа = 1)
	
	мДанныеПоКоличествуИзменений = Неопределено;
	Индикатор = ирОбщий.ПолучитьИндикаторПроцессаЛкс(ДеревоТаблиц.Строки.Количество(), "Классы метаданных");
	Для Каждого СтрокаДереваМетаданных Из ДеревоТаблиц.Строки Цикл
		ирОбщий.ОбработатьИндикаторЛкс(Индикатор);
		Если СтрокаДереваМетаданных.ПолноеИмя = "Константа" Тогда
			Для Каждого СтрокаОбъектаМД Из СтрокаДереваМетаданных.Строки Цикл
				ОбъектМД = ирКэш.ОбъектМДПоПолномуИмениЛкс(СтрокаОбъектаМД.ПолноеИмя);
				УзлыДляРегистрации = ирОбщий.ПолучитьРазрешенныеУзлыДляОбъектаМДЛкс(ОбъектМД, мВыбранныеУзлы, ТолькоДляОбъектовСАвтоматическойРегистрацией);
				Если УзлыДляРегистрации.Количество() = 0 Тогда
					Продолжить;
				КонецЕсли; 
				Если Ложь
					Или Действие = "ЗарегистироватьПервыеN" 
					Или Действие = "ЗарегистироватьВсе"
				Тогда
					ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, Константы[СтрокаОбъектаМД.Имя], Истина);
				ИначеЕсли Действие = "УдалитьРегистрациюВсех" Тогда
					ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, Константы[СтрокаОбъектаМД.Имя], Ложь);
				КонецЕсли; 
			КонецЦикла;
		ИначеЕсли ирОбщий.ЛиКорневойТипСсылочногоОбъектаБДЛкс(СтрокаДереваМетаданных.Имя) Тогда
			ИндикаторМД = ирОбщий.ПолучитьИндикаторПроцессаЛкс(СтрокаДереваМетаданных.Строки.Количество(), СтрокаДереваМетаданных.ПолноеИмя);
			Для Каждого СтрокаОбъектаМД Из СтрокаДереваМетаданных.Строки Цикл
				ирОбщий.ОбработатьИндикаторЛкс(ИндикаторМД);
				ОбъектМД = ирКэш.ОбъектМДПоПолномуИмениЛкс(СтрокаОбъектаМД.ПолноеИмя);
				УзлыДляРегистрации = ирОбщий.ПолучитьРазрешенныеУзлыДляОбъектаМДЛкс(ОбъектМД, мВыбранныеУзлы, ТолькоДляОбъектовСАвтоматическойРегистрацией);
				Если УзлыДляРегистрации.Количество() = 0 Тогда
					Продолжить;
				КонецЕсли; 
				Если Действие = "ЗарегистироватьПервыеN" Тогда
					ВыполнитьРегистрациюПервыхОбъектовДляУзла(ОбъектМД, УзлыДляРегистрации, КоличествоОбъектовКаждогоТипа);
				ИначеЕсли Действие = "ЗарегистрироватьВсе" Тогда
					ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, ОбъектМД, Истина, ИзменятьРегистрациюСДвижениями, ДвиженияВместеСПоследовательностями);
				ИначеЕсли Действие = "УдалитьРегистрациюВсех" Тогда
					ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, ОбъектМД, Ложь, ИзменятьРегистрациюСДвижениями, ДвиженияВместеСПоследовательностями);
				КонецЕсли; 
			КонецЦикла;
			ирОбщий.ОсвободитьИндикаторПроцессаЛкс();
		ИначеЕсли ирОбщий.ЛиКорневойТипРегистраБДЛкс(СтрокаДереваМетаданных.Имя) Тогда
			ИндикаторМД = ирОбщий.ПолучитьИндикаторПроцессаЛкс(СтрокаДереваМетаданных.Строки.Количество(), СтрокаДереваМетаданных.ПолноеИмя);
			Для Каждого СтрокаОбъектаМД Из СтрокаДереваМетаданных.Строки Цикл
				ирОбщий.ОбработатьИндикаторЛкс(ИндикаторМД);
				ОбъектМД = ирОбщий.ОбъектМДПоПолномуИмениТаблицыБДЛкс(СтрокаОбъектаМД.ПолноеИмя);
				УзлыДляРегистрации = ирОбщий.ПолучитьРазрешенныеУзлыДляОбъектаМДЛкс(ОбъектМД, мВыбранныеУзлы, ТолькоДляОбъектовСАвтоматическойРегистрацией);
				Если УзлыДляРегистрации.Количество() = 0 Тогда
					Продолжить;
				КонецЕсли; 
				Если Действие = "ЗарегистироватьПервыеN" Тогда
					ОписаниеТипаМетаданных = мСоответствиеСтрокДереваИМетаданных[СтрокаДереваМетаданных.Имя].ОписаниеТипа;
					ВыполнитьРегистрациюРегистра(СтрокаДереваМетаданных.Имя, СтрокаОбъектаМД.ПолноеИмя, УзлыДляРегистрации, КоличествоОбъектовКаждогоТипа);
				ИначеЕсли Действие = "ЗарегистрироватьВсе" Тогда
					ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, ОбъектМД, Истина, ИзменятьРегистрациюСДвижениями, ДвиженияВместеСПоследовательностями);
				ИначеЕсли Действие = "УдалитьРегистрациюВсех" Тогда
					ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, ОбъектМД, Ложь, ИзменятьРегистрациюСДвижениями, ДвиженияВместеСПоследовательностями);
				КонецЕсли; 
			КонецЦикла;
			ирОбщий.ОсвободитьИндикаторПроцессаЛкс();
		КонецЕсли;
	КонецЦикла;
	ирОбщий.ОсвободитьИндикаторПроцессаЛкс();
	ЗаказатьОбновлениеДереваПослеИзмененияРегистрации();

КонецПроцедуры

Процедура КнопкаИзменитьНомераНажатие(Элемент)
	
	Если ЭлементыФормы.Узлы.ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	ФормаИзмененияНомеров = ПолучитьФорму("ИзменениеНомеровСообщений", ЭтаФорма);
	ФормаИзмененияНомеров.УзелОбмена = ЭлементыФормы.Узлы.ТекущаяСтрока.Ссылка;
	ФормаИзмененияНомеров.ОткрытьМодально();
	КПУзлыОбновить();
	
КонецПроцедуры

Процедура ДеревоОбменаПередНачаломИзменения(Элемент, Отказ)
	
	Отказ = Истина;
	
КонецПроцедуры

Процедура ДеревоОбменаПриАктивизацииСтроки(Элемент = Неопределено)
	
	ирКлиент.ТабличноеПолеПриАктивизацииСтрокиЛкс(ЭтаФорма, Элемент);
	Если ЭтаФорма.ПоказыватьСодержимое Тогда
		КП_ТаблицаИзмененийОбновить();
	КонецЕсли; 
	
КонецПроцедуры

Процедура ОтображатьКоличествоОбъектовДляКоторыхЗарегистрированыИзмененияПриИзменении(Элемент = Неопределено)
	
	Если Не ВычислятьЧислоЗарегистрированныхИзменений Тогда
		ЭтаФорма.ОтображатьТолькоМетаданныеСИзменениями = Ложь;
		мДанныеПоКоличествуИзменений = Неопределено;
	КонецЕсли; 
	ПостроитьДеревоСоставаПланаОбмена();
	
КонецПроцедуры

Процедура ОтображатьТолькоМетаданныеСИзменениямиПриИзменении(Элемент)
	
	ПостроитьДеревоСоставаПланаОбмена();

КонецПроцедуры

Процедура ТаблицаИзмененийВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	Если Ложь
		Или Колонка.Имя = "НомерСообщения" 
		Или (Истина
			И Колонка.Имя = "Ссылка"
			И мТекущаяГруппаТипаМетаданных = "Ссылочный")
	Тогда
		КП_ТаблицаИзмененийОткрыть();
		СтандартнаяОбработка = Ложь;
		Возврат;
	Иначе
		КП_ТаблицаИзмененийОткрыть();
		СтандартнаяОбработка = Ложь;
		Возврат;
	КонецЕсли; 
	ирКлиент.ЯчейкаТабличногоПоляРасширенногоЗначения_ВыборЛкс(ЭтаФорма, Элемент, СтандартнаяОбработка);
	
КонецПроцедуры

Процедура КП_ТаблицаИзмененийОткрыть(Кнопка = Неопределено)
	
	ВыбраннаяСтрока = ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока;
	Если ВыбраннаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	ПолноеИмяМД = ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока.ПолноеИмя;
	Если Найти(ПолноеИмяМД, "Константа") = 1 Тогда
		//Предупреждение(Данные.Значение, , Строка(ПолноеИмя));
	Иначе
		Попытка
			Пустышка = Тип(СтрЗаменить(ПолноеИмяМД, ".", "Объект."));
			ЭтоСсылочныйОбъект = Истина;
		Исключение
			ЭтоСсылочныйОбъект = Ложь;
		КонецПопытки; 
		Если ЭтоСсылочныйОбъект Тогда
			ирКлиент.ОткрытьЗначениеЛкс(ВыбраннаяСтрока.Ссылка); // Ссылку надо брать, чтобы в управляемом режиме открывалась управляемая форма
		Иначе
			Отбор = Новый Структура;
			Для Каждого Колонка Из ТаблицаИзменений.Колонки Цикл
				Если ЛиСистемнаяКолонкаТаблицыИзменений(Колонка) Тогда
					Продолжить;
				КонецЕсли; 
				Отбор.Вставить(Колонка.Имя, ВыбраннаяСтрока[Колонка.Имя]);
			КонецЦикла;
			ирКлиент.ОткрытьФормуСпискаЛкс(ПолноеИмяМД, Отбор);
		КонецЕсли;
	КонецЕсли; 
	
КонецПроцедуры

Процедура КоманднаяПанельДереваОбъектовОткрытьФормуСписка(Кнопка)
	
	ТекущаяСтрока = ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	Если ТекущаяСтрока.Уровень() = 1 Тогда
		Если ТекущаяСтрока.Родитель.Имя = "Константа" Тогда
			ирКлиент.ОткрытьКонстантуВСпискеЛкс(ТекущаяСтрока.Имя);
		ИначеЕсли ТекущаяСтрока.Родитель.Имя = "Перерасчет" Тогда
			Возврат;
		Иначе
			ирКлиент.ОткрытьФормуСпискаЛкс(ТекущаяСтрока.ПолноеИмя);
		КонецЕсли; 
	КонецЕсли; 
	
КонецПроцедуры

Процедура ЗагружатьИзмененияПриИзменении(Элемент)
	
	ПостроитьДеревоСоставаПланаОбмена();

КонецПроцедуры

Функция ПостроительЗапросаДляТаблицыИзменений(ВыбраннаяСтрока = Неопределено, МаксимальнаяПорция = 0)

	Если ВыбраннаяСтрока = Неопределено Тогда
		ВыбраннаяСтрока = ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока;
	КонецЕсли; 
	ПолноеИмяТаблицыИзменений = ВыбраннаяСтрока.ПолноеИмя + "." + ирОбщий.ПеревестиСтроку("Изменения");
	ПоляТаблицыИзменений = ирКэш.ПоляТаблицыБДЛкс(ПолноеИмяТаблицыИзменений);
	МассивРавенствПолей = Новый Массив;
	УсловиеСоединенияТаблиц = "ИСТИНА";
	ИмяНомерСообщения = ирОбщий.ПеревестиСтроку("НомерСообщения");
	ИмяУзел = ирОбщий.ПеревестиСтроку("Узел");
	ИмяПометкаУдаления = ирОбщий.ПеревестиСтроку("ПометкаУдаления");
	Для Каждого СтрокаПоля Из ПоляТаблицыИзменений Цикл
		Если Ложь
			Или СтрокаПоля.Имя = ИмяНомерСообщения 
			Или СтрокаПоля.Имя = ИмяУзел
			Или (Истина
				// Разделитель
				И ТипЗнч(СтрокаПоля.Метаданные) = Тип("ОбъектМетаданных")
				И ирКэш.ДоступноОбщиеРеквизитыЛкс() 
				И Метаданные.ОбщиеРеквизиты.Индекс(СтрокаПоля.Метаданные) <> -1)
		Тогда
			Продолжить;
		КонецЕсли; 
		УсловиеСоединенияТаблиц = УсловиеСоединенияТаблиц + "		И _Т." + СтрокаПоля.Имя + " = _ТО." + СтрокаПоля.Имя;
		ЛюбоеПолеОсновногоОтбора = СтрокаПоля.Имя;
	КонецЦикла;
	Если ЗначениеЗаполнено(ИмяПланОбмена) Тогда
		ТекстВыбор = "ВЫРАЗИТЬ(_Т." + ИмяУзел + " КАК ПланОбмена." + ИмяПланОбмена + ")";
	Иначе
		ТекстВыбор = "_Т." + ИмяУзел;
	КонецЕсли; 
	ТекстВыбор = ТекстВыбор + " КАК Узел, _Т." + ИмяНомерСообщения + " КАК НомерСообщения, _Т.*";
	Если Ложь
		Или мТекущаяГруппаТипаМетаданных = "Ссылочный" 
		Или мТекущаяГруппаТипаМетаданных = "Регистр"
	Тогда
		ПоляКлюча = ирОбщий.СтруктураКлючаТаблицыБДЛкс(ВыбраннаяСтрока.ПолноеИмя, Ложь, Ложь, Ложь);
		Если ПоляКлюча.Количество() > 0 Тогда
			ТекстВыбор = ТекстВыбор + ", ВЫБОР КОГДА ЕСТЬNULL(_ТО." + ПоляКлюча[0].Представление + ", 0) = 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК " + мИмяПоляОбъектУдален;
			Если мТекущаяГруппаТипаМетаданных = "Ссылочный"  Тогда
				ТекстВыбор = ТекстВыбор + ", _ТО." + ИмяПометкаУдаления + " КАК ПометкаУдаления";
			КонецЕсли; 
		КонецЕсли; 
	КонецЕсли; 
	ТекстПервые = "";
	Если МаксимальнаяПорция > 0 Тогда
		ТекстПервые = " ПЕРВЫЕ " + Формат(МаксимальнаяПорция, "ЧГ=");
	КонецЕсли;
	ТекстЗапроса = "ВЫБРАТЬ РАЗЛИЧНЫЕ " + ТекстПервые + ТекстВыбор + " 
	|ИЗ " + ПолноеИмяТаблицыИзменений + " КАК _Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ " + ВыбраннаяСтрока.ПолноеИмя + " КАК _ТО
	|	ПО " + УсловиеСоединенияТаблиц;
	ТекстЗапроса = ТекстЗапроса + "
	|АВТОУПОРЯДОЧИВАНИЕ";
	Построитель = Новый ПостроительЗапроса(ТекстЗапроса);
	Построитель.ЗаполнитьНастройки();
	Для Каждого СтрокаПоля Из ПоляТаблицыИзменений Цикл
		Если СтрокаПоля.Имя = ИмяНомерСообщения Тогда
			Продолжить;
		КонецЕсли; 
		Построитель.Порядок.Добавить(СтрокаПоля.Имя, СтрокаПоля.Имя);
	КонецЦикла;
	Если мТекущаяГруппаТипаМетаданных = "Ссылочный" Тогда
		ИмяДата = ирОбщий.ПеревестиСтроку("Дата");
		ИмяСсылка = ирОбщий.ПеревестиСтроку("Ссылка");
		ДоступноеПолеДата = Построитель.ДоступныеПоля[ирОбщий.ПеревестиСтроку(ИмяСсылка)].Поля.Найти(ИмяДата);
		Если ДоступноеПолеДата <> Неопределено Тогда
			Построитель.ВыбранныеПоля.Добавить(ДоступноеПолеДата.ПутьКДанным, ИмяДата);
		КонецЕсли;
	КонецЕсли; 
	ЛишнееПоле = Построитель.ВыбранныеПоля.Найти(ИмяУзел + "1");
	Если ЛишнееПоле <> Неопределено Тогда 
		Построитель.ВыбранныеПоля.Удалить(ЛишнееПоле);
	Иначе
		Построитель.ВыбранныеПоля.Удалить(Построитель.ВыбранныеПоля.Найти(ИмяУзел)); // для англ. встроенного языка
	КонецЕсли; 
	ЛишнееПоле = Построитель.ВыбранныеПоля.Найти(ИмяНомерСообщения + "1");
	Если ЛишнееПоле <> Неопределено Тогда 
		Построитель.ВыбранныеПоля.Удалить(ЛишнееПоле);
	Иначе
		Построитель.ВыбранныеПоля.Удалить(Построитель.ВыбранныеПоля.Найти(ИмяНомерСообщения)); // для англ. встроенного языка
	КонецЕсли; 
	ЭлементОтбора = Построитель.Отбор.Добавить(ИмяУзел);
	ЭлементОтбора.Использование = Истина;
	ЭлементОтбора.ВидСравнения = ВидСравнения.ВСписке;
	СписокУзлов = Новый СписокЗначений;
	Если ЭлементыФормы.ИтогиТаблицыПоУзлам.ТекущаяСтрока.Узел = "<Все>" Тогда
		СписокУзлов.ЗагрузитьЗначения(мВыбранныеУзлы);
	Иначе
		СписокУзлов.Добавить(ЭлементыФормы.ИтогиТаблицыПоУзлам.ТекущаяСтрока.Узел);
	КонецЕсли; 
	ЭлементОтбора.Значение = СписокУзлов;
	
	// Антибаг 8.2.14 http://partners.v8.1c.ru/forum/thread.jsp?id=1017264#1017264
	Если Истина
		И ирКэш.ДоступноОбщиеРеквизитыЛкс()
		И мТекущаяГруппаТипаМетаданных = "Регистр" 
	Тогда
		ОбъектМетаданных = ирОбщий.ОбъектМДПоПолномуИмениТаблицыБДЛкс(ВыбраннаяСтрока.ПолноеИмя);
		Для Каждого ОбщийРеквизит Из Метаданные.ОбщиеРеквизиты Цикл
			ВыбранноеПоле = Построитель.ВыбранныеПоля.Найти(ОбщийРеквизит.Имя);
			Если Истина
				И ВыбранноеПоле <> Неопределено
				И ОбъектМетаданных.Измерения.Найти(ОбщийРеквизит.Имя) = Неопределено
			Тогда
				Если ирОбщий.ЛиОбщийРеквизитИспользуетсяВОбъектеМетаданныхЛкс(ОбщийРеквизит, ОбъектМетаданных) Тогда
					Построитель.ВыбранныеПоля.Удалить(ВыбранноеПоле);
				КонецЕсли; 
			КонецЕсли; 
		КонецЦикла; 
	КонецЕсли;
	Возврат Построитель;

КонецФункции

Процедура КП_ТаблицаИзмененийОбновить(Кнопка = Неопределено)
	
	ОбновитьИтогиПоТаблице();
	СтруктураТекущейСтроки = Неопределено;
	ТекущаяКолонка = ЭлементыФормы.ТаблицаИзменений.ТекущаяКолонка;
	Если ТекущаяКолонка <> Неопределено Тогда
		ТекущаяКолонка = ТекущаяКолонка.Данные;
	КонецЕсли; 
	ТекущаяСтрокаИзменений = ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока;
	Если ТекущаяСтрокаИзменений <> Неопределено Тогда
		СтруктураТекущейСтроки = Новый Структура();
		Если мТекущаяГруппаТипаМетаданных = "Ссылочный" Тогда
			ИмяСсылка = ирОбщий.ПеревестиСтроку("Ссылка");
			СтруктураТекущейСтроки.Вставить(ИмяСсылка, ТекущаяСтрокаИзменений[ИмяСсылка]);
		Иначе
			Для Каждого Колонка Из ТаблицаИзменений.Колонки Цикл
				Если Колонка.Имя = "НомерСообщения" Тогда
					Продолжить;
				КонецЕсли; 
				СтруктураТекущейСтроки.Вставить(Колонка.Имя, ТекущаяСтрокаИзменений[Колонка.Имя]);
			КонецЦикла; 
		КонецЕсли; 
	КонецЕсли; 
	ТаблицаИзменений.Очистить();
	ТаблицаИзменений.Колонки.Очистить();
	ЭлементыФормы.ТаблицаИзменений.ТолькоПросмотр = Истина;
	ВыбраннаяСтрока = ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока;
	Если ВыбраннаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	УровеньВыбраннойСтроки = ВыбраннаяСтрока.Уровень();
	ЭлементыФормы.ТаблицаИзменений.ТолькоПросмотр = (УровеньВыбраннойСтроки = 0);
	Если УровеньВыбраннойСтроки = 1 И ВыбраннаяСтрока.ЕстьДоступ <> Ложь Тогда
		ОбновитьИтогиПоТаблице();
		мМакетныйОбъект = ирОбщий.ПолучитьМакетныйОбъектДанныхТаблицыБДЛкс(ВыбраннаяСтрока.ПолноеИмя, мТекущаяГруппаТипаМетаданных);
		Построитель = ПостроительЗапросаДляТаблицыИзменений();
		//ЧислоСтрокДляЗагрузки = ирОбщий.КонтрольРазмераВыборкиПользователемЛкс(Построитель);
		//Если ЧислоСтрокДляЗагрузки > 0 Тогда
		//	Построитель = ПолучитьПостроительДляТаблицыИзменений(, ЧислоСтрокДляЗагрузки);
		//КонецЕсли;
		//// http://partners.v8.1c.ru/forum/thread.jsp?id=1034151#1034151
		////МаксимальныйРазмер = 500000;
		////Построитель = ПолучитьПостроительДляТаблицыИзменений(, МаксимальныйРазмер);
		
		Состояние("Выборка содержимого таблицы изменений...");
		мРезультатЗапроса = Построитель.Результат;
		ирКлиент.ЗагрузитьВыборкуВТабличноеПолеПервуюПорциюЛкс(ЭтаФорма, мРезультатЗапроса, мВыборкаРезультата,
			ЭлементыФормы.КП_ТаблицаИзменений);
		Состояние("Подготовка данных таблицы изменений...");
		// Дорогая операция!
		ТаблицаИзменений = ирОбщий.ТаблицаСКолонкамиБезТипаNullЛкс(ТаблицаИзменений,,, "НомерСообщения");
		Состояние("");
		Если мТекущаяГруппаТипаМетаданных = "Ссылочный" Тогда
			ТаблицаИзменений.Колонки.ПометкаУдаления.Заголовок = "Ссылка.Пометка удаления";
			Если ТаблицаИзменений.Колонки.Найти("Дата") <> Неопределено Тогда
				ТаблицаИзменений.Колонки.Дата.Заголовок = "Ссылка.Дата";
			КонецЕсли; 
		КонецЕсли; 
		КолонкаОбъектУдален = ТаблицаИзменений.Колонки.Найти(мИмяПоляОбъектУдален);
		Если КолонкаОбъектУдален <> Неопределено Тогда
			КолонкаОбъектУдален.Заголовок = "Объект удален";
		КонецЕсли; 
		ТаблицаИзменений.Колонки.НомерСообщения.Заголовок = "Номер сообщения";
	Иначе
		мРезультатЗапроса = Неопределено;
		мВыборкаРезультата = Неопределено;
		ОбновитьРазмерДинамическойТаблицы();
	КонецЕсли;
	ЭлементыФормы.ТаблицаИзменений.СоздатьКолонки();
	Для Каждого КолонкаТП Из ЭлементыФормы.ТаблицаИзменений.Колонки Цикл
		Если Ложь
			Или КолонкаТП.Имя = "НомерСообщения" 
			Или (Истина
				И мТекущаяГруппаТипаМетаданных = "Ссылочный"
				И КолонкаТП.Имя <> "Ссылка"
				И КолонкаТП.Имя <> "Узел")
			Или (Истина
				И мТекущаяГруппаТипаМетаданных = "Регистр"
				И КолонкаТП.Имя = мИмяПоляОбъектУдален)
		Тогда
			КолонкаТП.ТолькоПросмотр = Истина;
		Иначе
			КолонкаТП.ЭлементУправления.УстановитьДействие("ОкончаниеВводаТекста", Новый Действие("ПолеВводаКолонкиСсылка_ОкончаниеВводаТекста"));
		КонецЕсли;
		КолонкаТП.ЭлементУправления.УстановитьДействие("НачалоВыбора", Новый Действие("ПолеВводаТаблицыИзменений_НачалоВыбора"));
		КолонкаТП.ТекстШапки = ТаблицаИзменений.Колонки[КолонкаТП.Имя].Заголовок;
	КонецЦикла;
	КолонкаНомерСообщения = ЭлементыФормы.ТаблицаИзменений.Колонки.Найти("НомерСообщения");
	Если КолонкаНомерСообщения <> Неопределено Тогда
		ЭлементыФормы.ТаблицаИзменений.Колонки.Сдвинуть(КолонкаНомерСообщения, - ЭлементыФормы.ТаблицаИзменений.Колонки.Индекс(КолонкаНомерСообщения));
	КонецЕсли; 
	ЭлементыФормы.ТаблицаИзменений.ИзменятьСоставСтрок = мВыбранныеУзлы.Количество() > 0;
	Если ЭлементыФормы.ТаблицаИзменений.Колонки.Количество() > 0 Тогда
		ЭлементыФормы.ТаблицаИзменений.Колонки.Узел.Видимость = ЭлементыФормы.ИтогиТаблицыПоУзлам.ТекущаяСтрока.Узел = "<Все>";
		Если Не ЭлементыФормы.ТаблицаИзменений.Колонки.Узел.Видимость Тогда
			ЭлементыФормы.ТаблицаИзменений.ИзменятьСоставСтрок = ТаблицаИзменений.Колонки.Узел.ТипЗначения.СодержитТип(ТипЗнч(ЭлементыФормы.ИтогиТаблицыПоУзлам.ТекущаяСтрока.Узел));
		КонецЕсли; 
	КонецЕсли; 
	КолонкаОбъектУдален = ЭлементыФормы.ТаблицаИзменений.Колонки.Найти(мИмяПоляОбъектУдален);
	Если КолонкаОбъектУдален <> Неопределено Тогда
		КолонкаОбъектУдален.КартинкаШапки = ирКэш.КартинкаПоИмениЛкс("ирОтсутствует");
		КолонкаОбъектУдален.КартинкиСтрок = ирКэш.КартинкаПоИмениЛкс("ирСостоянияФлажка");
		КолонкаОбъектУдален.ИзменятьВидимость = Ложь;
		КолонкаОбъектУдален.ПодсказкаВШапке = "Признак отсутствия строк с таким отбором в основной таблице";
		ирКлиент.НастроитьКолонкуКартинкиЛкс(КолонкаОбъектУдален);
	КонецЕсли; 
	ЭлементыФормы.КП_ТаблицаИзменений.Кнопки.ПодборВТаблицуИзменений.Доступность = ЭлементыФормы.ТаблицаИзменений.ИзменятьСоставСтрок;
	ирОбщий.НастроитьДобавленныеКолонкиТабличногоПоляЛкс(ЭлементыФормы.ТаблицаИзменений);
	Если СтруктураТекущейСтроки <> Неопределено Тогда
		НоваяСтруктураТекущейСтроки = Новый Структура();
		Для Каждого Колонка Из ТаблицаИзменений.Колонки Цикл
			Если Колонка.Имя = "НомерСообщения" Тогда
				Продолжить;
			КонецЕсли; 
			Если СтруктураТекущейСтроки.Свойство(Колонка.Имя) Тогда
				НоваяСтруктураТекущейСтроки.Вставить(Колонка.Имя, СтруктураТекущейСтроки[Колонка.Имя]);
			КонецЕсли; 
		КонецЦикла;
		НайденныеСтроки = ТаблицаИзменений.НайтиСтроки(НоваяСтруктураТекущейСтроки);
		Если НайденныеСтроки.Количество() > 0 Тогда
			НоваяТекущаяСтрока = НайденныеСтроки[0];
			Попытка
				ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока = НоваяТекущаяСтрока;
			Исключение
				// Если вызывано из ПриОкончанииРедактирования строки
			КонецПопытки; 
		КонецЕсли; 
	КонецЕсли; 
	Если ТекущаяКолонка <> Неопределено Тогда
		НоваяТекущаяКолонка = ЭлементыФормы.ТаблицаИзменений.Колонки.Найти(ТекущаяКолонка);
		Если НоваяТекущаяКолонка <> Неопределено И НоваяТекущаяКолонка.Видимость Тогда
			ЭлементыФормы.ТаблицаИзменений.ТекущаяКолонка = НоваяТекущаяКолонка;
		КонецЕсли; 
	КонецЕсли; 
	
КонецПроцедуры

Процедура ПолеВводаТаблицыИзменений_НачалоВыбора(Элемент, СтандартнаяОбработка)
	
	ирКлиент.ПолеВводаКолонкиРасширенногоЗначения_НачалоВыбораЛкс(ЭтаФорма, ЭлементыФормы.ТаблицаИзменений, СтандартнаяОбработка,, Истина);

КонецПроцедуры

Процедура ТаблицаИзмененийПередУдалением(Элемент, Отказ)
	
	Отказ = Истина;
	ВыделенныеСтроки = ЭлементыФормы.ТаблицаИзменений.ВыделенныеСтроки;
	Если ВыделенныеСтроки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	Ответ = Вопрос("Вы действительно хотите удалить регистрацию по " + ВыделенныеСтроки.Количество() + " изменениям?", РежимДиалогаВопрос.ОКОтмена);
	Если Ответ <> КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;
	СтрокаДереваТекущихДанных = ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные;
	СтрокаОбновления = ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные;
	Индикатор = ирОбщий.ПолучитьИндикаторПроцессаЛкс(ВыделенныеСтроки.Количество(), "Удаление регистрации");
	НачальноеКоличество = ВыделенныеСтроки.Количество(); 
	Для СчетчикВыделенныеСтроки = 1 По НачальноеКоличество Цикл
		ВыделеннаяСтрока = ВыделенныеСтроки[НачальноеКоличество - СчетчикВыделенныеСтроки];
		ирОбщий.ОбработатьИндикаторЛкс(Индикатор);
		КлючОбъекта = ПолучитьКлючОбъектаСтроки(ВыделеннаяСтрока);
		ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(ВыделеннаяСтрока.Узел, КлючОбъекта, Ложь);
		ТаблицаИзменений.Удалить(ВыделеннаяСтрока);
	КонецЦикла;
	ирОбщий.ОсвободитьИндикаторПроцессаЛкс();
	ОбновитьИтогиПоТаблице();
	//КП_ТаблицаИзмененийОбновить(); // Долго
	ОбновитьРазмерДинамическойТаблицы();

КонецПроцедуры

Процедура ТаблицаИзмененийПередНачаломИзменения(Элемент, Отказ)
	
	Отказ = Истина;
	
КонецПроцедуры

Процедура ТаблицаИзмененийПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	
	Если ОтменаРедактирования Тогда
		Возврат;
	КонецЕсли;
	Узел = Неопределено;
	Если ТаблицаИзменений.Колонки.Найти("Узел") <> Неопределено Тогда
		Узел = ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока.Узел;
	КонецЕсли; 
	Если Не ЗначениеЗаполнено(Узел) Тогда
		Узел = мВыбранныеУзлы;
	КонецЕсли; 
	СтруктураОбъекта = ПолучитьОбъектДанныхПоСтрокеИзменений();
	Если СтруктураОбъекта = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(Узел, СтруктураОбъекта);
	//ОбновитьИтогиПоТаблице();
	КП_ТаблицаИзмененийОбновить();
	
КонецПроцедуры

Процедура ТаблицаИзмененийПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки) Экспорт
	
	ирКлиент.ТабличноеПолеПриВыводеСтрокиЛкс(ЭтаФорма, Элемент, ОформлениеСтроки, ДанныеСтроки, ЭлементыФормы.КП_ТаблицаИзменений.Кнопки.Идентификаторы);
	
КонецПроцедуры

Процедура ТаблицаИзмененийПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	
	Если Не ОтменаРедактирования Тогда
		Если мТекущаяГруппаТипаМетаданных = "Ссылочный" Тогда
			ИмяСсылка = ирОбщий.ПеревестиСтроку("Ссылка");
			Если Не ЗначениеЗаполнено(Элемент.ТекущиеДанные[ИмяСсылка]) Тогда
				Отказ = Истина;
			КонецЕсли; 
		КонецЕсли; 
	КонецЕсли; 
	
КонецПроцедуры

Процедура ПолеВводаКолонкиСсылка_ОкончаниеВводаТекста(Элемент, Текст, Значение, СтандартнаяОбработка)
	
	ирКлиент.ПолеВвода_ОкончаниеВводаТекстаЛкс(Элемент, Текст, Значение, СтандартнаяОбработка);
	
КонецПроцедуры

Процедура ПланОбменаПриИзмененииБезВычисленияКоличества()
	
	СтароеВычислятьКоличество = ВычислятьЧислоЗарегистрированныхИзменений;
	ВычислятьЧислоЗарегистрированныхИзменений = Ложь;
	ПланОбменаПриИзменении();
	ВычислятьЧислоЗарегистрированныхИзменений = СтароеВычислятьКоличество;

КонецПроцедуры

Процедура КП_ТаблицаИзмененийКонсольКомпоновки(Кнопка)
	
	Если ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока = Неопределено Или ЭлементыФормы.ТаблицаИзменений.Колонки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли; 
	Построитель = ПостроительЗапросаДляТаблицыИзменений();
	// Из-за бага платформы пока так не стоит делать
	//Построитель.Текст = СтрЗаменить(Построитель.Текст, "АВТОУПОРЯДОЧИВАНИЕ", "");
	//Обработки.ирКонсольКомпоновокДанных.Создать().ОткрытьПоЗапросу(, Новый Структура("Узел", УзелОбмена));
	Запрос = Построитель.ПолучитьЗапрос();
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "АВТОУПОРЯДОЧИВАНИЕ", "");
	КонсольКомпоновокДанных = ирОбщий.СоздатьОбъектПоИмениМетаданныхЛкс("Обработка.ирКонсольКомпоновокДанных");
	#Если Сервер И Не Сервер Тогда
		КонсольКомпоновокДанных = Обработки.ирКонсольКомпоновокДанных.Создать();
	#КонецЕсли
    КонсольКомпоновокДанных.ОткрытьПоЗапросу(Запрос);
	
	//Обработки.ирКонсольКомпоновокДанных.Создать().ОткрытьПоОбъектуМетаданных(ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные.ПолноеИмя + ".Изменения", Новый Структура("Узел", УзелОбмена));
	
КонецПроцедуры

Процедура ПланОбменаНачалоВыбораИзСписка(Элемент, СтандартнаяОбработка)
	
	ирОбщий.ПолеВводаСИсториейВыбора_ОбновитьСписокЛкс(Элемент, ЭтаФорма);

КонецПроцедуры

Процедура КП_ТаблицаИзмененийЗагрузитьПолностью(Кнопка)
	
	//ирКлиент.ЗагрузитьВыборкуВТабличноеПолеПолностьюЛкс(ЭтаФорма, мВыборкаРезультата, ЭлементыФормы.КП_ТаблицаИзменений);
	ирКлиент.ЗагрузитьВыборкуВТабличноеПолеПервуюПорциюЛкс(ЭтаФорма, мРезультатЗапроса, мВыборкаРезультата, ЭлементыФормы.КП_ТаблицаИзменений,, 0);
	
КонецПроцедуры

Процедура ОбновитьРазмерДинамическойТаблицы() Экспорт

	ирКлиент.ПослеЗагрузкиВыборкиВТабличноеПолеЛкс(ЭтаФорма, мВыборкаРезультата, ЭлементыФормы.КП_ТаблицаИзменений, ЭлементыФормы.КоличествоСтрокИзменений);

КонецПроцедуры // ОбновитьРазмерТаблицы()

Процедура КП_ТаблицаИзмененийСброситьНомер(Кнопка)
	
	Отказ = Истина;
	ВыделенныеСтроки = ЭлементыФормы.ТаблицаИзменений.ВыделенныеСтроки;
	Если ВыделенныеСтроки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	Ответ = Вопрос("Вы действительно хотите сбросить номера сообщений по " + ВыделенныеСтроки.Количество() + " объектам?", РежимДиалогаВопрос.ОКОтмена);
	Если Ответ <> КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;
	СтрокаДереваТекущихДанных = ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные;
	СтрокаОбновления = ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные;
	Индикатор = ирОбщий.ПолучитьИндикаторПроцессаЛкс(ВыделенныеСтроки.Количество(), "Сброс номеров сообщений");
	Для Каждого ВыделеннаяСтрока Из ВыделенныеСтроки Цикл
		ирОбщий.ОбработатьИндикаторЛкс(Индикатор);
		КлючОбъекта = ПолучитьКлючОбъектаСтроки(ВыделеннаяСтрока);
		ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(ВыделеннаяСтрока.Узел, КлючОбъекта);
		ВыделеннаяСтрока.НомерСообщения = Null;
	КонецЦикла;
	ирОбщий.ОсвободитьИндикаторПроцессаЛкс();
	
КонецПроцедуры

Функция ПолучитьКлючОбъектаСтроки(ВыделеннаяСтрока)

	КлючОбъекта = Неопределено;
	Если мТекущаяГруппаТипаМетаданных = "Ссылочный" Тогда
		ИмяСсылка = ирОбщий.ПеревестиСтроку("Ссылка");
		КлючОбъекта = ВыделеннаяСтрока[ИмяСсылка];
	ИначеЕсли мТекущаяГруппаТипаМетаданных = "Регистр" Тогда
		КлючОбъекта = мМакетныйОбъект;
		ЗаполнитьОтборМакетногоОбъекта(ВыделеннаяСтрока);
	ИначеЕсли мТекущаяГруппаТипаМетаданных = "Константа" Тогда
		КлючОбъекта = мМакетныйОбъект;
	КонецЕсли; 
	Возврат КлючОбъекта;

КонецФункции

Функция ЛиСистемнаяКолонкаТаблицыИзменений(Знач Колонка)
	
	Возврат Ложь
		Или Колонка.Имя = "НомерСообщения" 
		Или Колонка.Имя = "Узел"
		Или Колонка.Имя = мИмяПоляОбъектУдален;

КонецФункции

Процедура КП_ТаблицаИзмененийРедакторОбъектаБДСтроки(Кнопка)
	
	ТекущаяСтрока = ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	КлючОбъекта = ПолучитьКлючОбъектаСтроки(ТекущаяСтрока);
	ирКлиент.ОткрытьСсылкуВРедактореОбъектаБДЛкс(КлючОбъекта);
	
КонецПроцедуры

Процедура ПланОбменаНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	Форма = ирКэш.Получить().ПолучитьФорму("ВыборОбъектаМетаданных", Элемент, ЭтаФорма);
	Форма.НачальноеЗначениеВыбора = Новый Структура("ФильтрКорневыхТипов, НачальноеЗначениеВыбора", "ПланОбмена", "ПланОбмена." + Элемент.Значение);
	Форма.ОткрытьМодально();
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

Процедура ИмяПланОбменаОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если ТипЗнч(ВыбранноеЗначение) = Тип("Структура") Тогда
		лПолноеИмяОбъекта = Неопределено;
		Если ВыбранноеЗначение.Свойство("ПолноеИмяОбъекта", лПолноеИмяОбъекта) Тогда
			ЭтаФорма.ИмяПланОбмена = ирОбщий.ПоследнийФрагментЛкс(лПолноеИмяОбъекта);
			ПланОбменаПриИзменении(Элемент);
		КонецЕсли;
		СтандартнаяОбработка = Ложь;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбновитьСохраняемыеПометкиУзлов()
	Для Каждого ИмяПланОбменаЦикл Из ирОбщий.РазличныеЗначенияКолонкиТаблицыЛкс(Узлы, "ПланОбмена") Цикл
		Для Каждого СтрокаУзла Из мПометкиУзлов.НайтиСтроки(Новый Структура("ПланОбмена", ИмяПланОбменаЦикл)) Цикл 
			мПометкиУзлов.Удалить(СтрокаУзла);
		КонецЦикла;
	КонецЦикла;
	ирОбщий.ЗагрузитьВТаблицуЗначенийЛкс(Узлы, мПометкиУзлов);
	
КонецПроцедуры

Процедура ОбновлениеОтображения()
	
	ЭлементыФормы.ОтображатьТолькоМетаданныеСИзменениями.Доступность = ВычислятьЧислоЗарегистрированныхИзменений;
	ирКлиент.Форма_ОбновлениеОтображенияЛкс(ЭтаФорма);
	
КонецПроцедуры

Процедура УзлыПриИзмененииФлажка(Элемент, Колонка)
	
	ирКлиент.ТабличноеПолеПриИзмененииФлажкаЛкс(ЭтаФорма, Элемент, Колонка);

КонецПроцедуры

Процедура ИмяПланОбменаОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	Если ЗначениеЗаполнено(ИмяПланОбмена) Тогда
		ОткрытьФорму("ПланОбмена." + ИмяПланОбмена + ".ФормаСписка");
	КонецЕсли; 
	
КонецПроцедуры

Процедура УзлыВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	ирКлиент.ОткрытьЗначениеЛкс(ВыбраннаяСтрока.Ссылка);
	
КонецПроцедуры

Процедура КПУзлыОбновить(Кнопка = Неопределено, ПринудительныйПризнакИзменениеВыбранныхУзлов = Неопределено)
	
	мДанныеПоКоличествуИзменений = Неопределено;
	СостояниеСтрокУзлов = ирКлиент.ТабличноеПолеСостояниеСтрокЛкс(ЭлементыФормы.Узлы, "Ссылка");
	ОбновитьСохраняемыеПометкиУзлов();
	Узлы.Очистить();
	//ИтогиТаблицыПоУзлам.Очистить();
	мИменаПлановОбмена = Новый Массив;
	Если ЗначениеЗаполнено(ИмяПланОбмена) Тогда
		Для Каждого МетаПланОбмена Из Метаданные.ПланыОбмена Цикл
			КолонкаТП = ЭлементыФормы.ДеревоТаблиц.Колонки["Авторегистрация_" + МетаПланОбмена.Имя];
			КолонкаТП.Видимость = Ложь;
		КонецЦикла;
		мИменаПлановОбмена.Добавить(ИмяПланОбмена);
	Иначе
		Для Каждого МетаПланОбмена Из Метаданные.ПланыОбмена Цикл
			мИменаПлановОбмена.Добавить(МетаПланОбмена.Имя);
		КонецЦикла;
	КонецЕсли; 
	Если мИменаПлановОбмена.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	Для Каждого ИмяПланаОбменаЦикл Из мИменаПлановОбмена Цикл
		Если Не мСоставыПлановОбмена.Свойство(ИмяПланаОбменаЦикл) Тогда
			мСоставыПлановОбмена.Вставить(ИмяПланаОбменаЦикл, Метаданные.ПланыОбмена[ИмяПланаОбменаЦикл].Состав);
		КонецЕсли;
	КонецЦикла;
	//ЭлементыФормы.ДеревоТаблиц.Колонки.Авторегистрация.Видимость = ЗначениеЗаполнено(ИмяПланОбмена);
	ЭлементыФормы.Узлы.Колонки.ПланОбмена.Видимость = Не ЗначениеЗаполнено(ИмяПланОбмена);
	ЭлементыФормы.Узлы.Колонки.РИБ.Видимость = Не ЗначениеЗаполнено(ИмяПланОбмена);
	Для Каждого лИмяПланаОбмена Из мИменаПлановОбмена Цикл
		КолонкаТП = ЭлементыФормы.ДеревоТаблиц.Колонки["Авторегистрация_" + лИмяПланаОбмена];
		КолонкаТП.Видимость = Истина;
		ВыборкаУзлов = ПланыОбмена[лИмяПланаОбмена].Выбрать();
		#Если Сервер И Не Сервер Тогда
		    ВыборкаУзлов = ПланыОбмена.ПолныйИис.Выбрать();
		#КонецЕсли
		Пока ВыборкаУзлов.Следующий() Цикл
			СтрокаУзла = Узлы.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаУзла, ВыборкаУзлов);
			Если мВыбранныеУзлы.Найти(ВыборкаУзлов.Ссылка) <> Неопределено Тогда
				СтрокаУзла.Пометка = Истина;
			КонецЕсли; 
			СтрокаПометки = мПометкиУзлов.Найти(ВыборкаУзлов.Ссылка);
			Если СтрокаПометки <> Неопределено И СтрокаПометки.Пометка Тогда
				СтрокаУзла.Пометка = Истина;
			КонецЕсли;
			СтрокаУзла.СобственныйУзел = ПланыОбмена[лИмяПланаОбмена].ЭтотУзел() = ВыборкаУзлов.Ссылка;
			ЗаполнитьСтрокуУзла(СтрокаУзла);
		КонецЦикла;
	КонецЦикла;
	Узлы.Сортировать("ПланОбмена, СобственныйУзел Убыв, Ссылка");
	НачальноеКоличество = мВыбранныеУзлы.Количество(); 
	ВыбранныеУзлыИзменены = Ложь;
	Для СчетчикмВыбранныеУзлы = 1 По НачальноеКоличество Цикл
		ВыбранныйУзел = мВыбранныеУзлы[НачальноеКоличество - СчетчикмВыбранныеУзлы];
		Если Узлы.Найти(ВыбранныйУзел, "Ссылка") = Неопределено Тогда
			Если Не ЗначениеЗаполнено(ИмяПланОбмена) Или ТипЗнч(ВыбранныйУзел) = Тип("ПланОбменаСсылка." + ИмяПланОбмена) Тогда
				НоваяСтрока = Узлы.Добавить();
				НоваяСтрока.Ссылка = ВыбранныйУзел;
				НоваяСтрока.Пометка = Истина;
				ЗаполнитьСтрокуУзла(НоваяСтрока);
			Иначе
				мВыбранныеУзлы.Удалить(НачальноеКоличество - СчетчикмВыбранныеУзлы);
				ВыбранныеУзлыИзменены = Истина;
			КонецЕсли; 
		КонецЕсли;
	КонецЦикла;
	Если Не ЗначениеЗаполнено(ИмяПланОбмена) Тогда
		мПометкиУзлов.Очистить();
	КонецЕсли;
	ирКлиент.ТабличноеПолеВосстановитьСостояниеСтрокЛкс(ЭлементыФормы.Узлы, СостояниеСтрокУзлов);
	Если Ложь
		Или ПринудительныйПризнакИзменениеВыбранныхУзлов = Истина 
		Или ВыбранныеУзлыИзменены
		Или ВычислятьЧислоЗарегистрированныхИзменений // Это нужно, чтобы несуществующие узлы обновлялись
	Тогда
		ПриИзмененииВыбранныхУзлов();
	Иначе
		ОбновитьВидимостьКолонокАвторегистрации();
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьСтрокуУзла(НоваяСтрока)
	
	НоваяСтрока.ПланОбмена = НоваяСтрока.Ссылка.Метаданные().Имя;
	НоваяСтрока.РИБ = НоваяСтрока.Ссылка.Метаданные().РаспределеннаяИнформационнаяБаза;
	
КонецПроцедуры

Процедура ПриИзмененииВыбранныхУзлов()
	
	ОбновитьВидимостьКолонокАвторегистрации();
	ИтогиТаблицыПоУзлам.Очистить();
	СтрокаИтоговТаблицы = ИтогиТаблицыПоУзлам.Добавить();
	СтрокаИтоговТаблицы.Узел = "<Все>";
	ЭлементыФормы.ИтогиТаблицыПоУзлам.ТекущаяСтрока = СтрокаИтоговТаблицы;
	Для Каждого ВыбранныйУзел Из мВыбранныеУзлы Цикл
		СтрокаИтоговТаблицы = ИтогиТаблицыПоУзлам.Добавить();
		СтрокаИтоговТаблицы.Узел = ВыбранныйУзел;
	КонецЦикла;
	ОбновитьКоличествоВДереве();
	
КонецПроцедуры

Процедура ОбновитьКоличествоВДереве(ПринудительноВыполнитьЗапрос = Ложь, Перезапустить = Истина)
	
	Если Ложь
		Или ОтображатьТолькоМетаданныеСИзменениями 
		Или ОтображатьТолькоТаблицыСАвторегистрацией 
		Или ДеревоТаблиц.Строки.Количество() = 0
	Тогда
		ПостроитьДеревоСоставаПланаОбмена(ПринудительноВыполнитьЗапрос, Перезапустить);
	Иначе
		ОбновитьСтатистикуВСоставеПланаОбмена(, ПринудительноВыполнитьЗапрос, Перезапустить);
	КонецЕсли;

КонецПроцедуры

// Предопределеный метод
Процедура ПроверкаЗавершенияФоновыхЗаданий() Экспорт 
	
	ирКлиент.ПроверитьЗавершениеФоновыхЗаданийФормыЛкс(ЭтаФорма);
	
КонецПроцедуры

Процедура ОбновитьСтатистикуЗавершение(СостояниеЗадания = Неопределено, РезультатЗадания = Неопределено) Экспорт 
	
	Если Ложь
		Или СостояниеЗадания = Неопределено
		Или СостояниеЗадания = СостояниеФоновогоЗадания.Завершено 
	Тогда
		мДанныеПоКоличествуИзменений = РезультатЗадания;
		ПерезаполнитьКолонкиКоличества();
	КонецЕсли; 
	мДлительностьСбораСтатистики = ТекущаяДата() - мМоментЗапускаЗадания;

КонецПроцедуры

Функция ОбновитьВидимостьКолонокАвторегистрации()
	
	ВыбранныеСтроки = Узлы.НайтиСтроки(Новый Структура("Пометка", Истина));
	ТекстУзлов = "";
	СтруктураВидимостиКолонок = Новый Структура;
	Для Каждого МетаПланОбмена Из Метаданные.ПланыОбмена Цикл
		ИмяКолонки = "Авторегистрация_" + МетаПланОбмена.Имя;
		ВидимостьКолонки = МетаПланОбмена.Имя = ИмяПланОбмена;
		СтруктураВидимостиКолонок.Вставить(ИмяКолонки, ВидимостьКолонки);
	КонецЦикла; 
	мВыбранныеУзлы = Новый Массив();
	Для Каждого ВыбраннаяСтрока Из ВыбранныеСтроки Цикл
		Если ТекстУзлов <> "" Тогда
			ТекстУзлов = ТекстУзлов + ", ";
		КонецЕсли; 
		ТекстУзлов = ТекстУзлов + СокрЛП(ВыбраннаяСтрока.Код);
		мВыбранныеУзлы.Добавить(ВыбраннаяСтрока.Ссылка);
		СтруктураВидимостиКолонок["Авторегистрация_" + ВыбраннаяСтрока.Ссылка.Метаданные().Имя] = Истина;
	КонецЦикла;
	Для Каждого КлючИЗначение Из СтруктураВидимостиКолонок Цикл
		КолонкаПланаОбмена = ЭлементыФормы.ДеревоТаблиц.Колонки[КлючИЗначение.Ключ];
		Если мВыбранныеУзлы.Количество() > 0 Или ЗначениеЗаполнено(ИмяПланОбмена) Тогда
			КолонкаПланаОбмена.Видимость = КлючИЗначение.Значение;
		Иначе
			КолонкаПланаОбмена.Видимость = Истина;
		КонецЕсли;
	КонецЦикла;
	ЭтаФорма.ПредставлениеВыбранныхУзлов = "Выбрано " + мВыбранныеУзлы.Количество() + " узлов";
	Если ЗначениеЗаполнено(ТекстУзлов) Тогда
		ЭтаФорма.ПредставлениеВыбранныхУзлов = ЭтаФорма.ПредставлениеВыбранныхУзлов + ": " + ТекстУзлов;
	КонецЕсли;
	ЭлементыФормы.Узлы.Колонки.КоличествоЗарегистрированных.Видимость = ВычислятьЧислоЗарегистрированныхИзменений;
	ЭлементыФормы.Узлы.Колонки.КоличествоВыгруженных.Видимость = ВычислятьЧислоЗарегистрированныхИзменений;
	ЭлементыФормы.Узлы.Колонки.КоличествоНевыгруженных.Видимость = ВычислятьЧислоЗарегистрированныхИзменений;
	ЭлементыФормы.ДеревоТаблиц.Колонки.КоличествоЗарегистрированных.Видимость = ВычислятьЧислоЗарегистрированныхИзменений;
	ЭлементыФормы.ДеревоТаблиц.Колонки.КоличествоВыгруженных.Видимость = ВычислятьЧислоЗарегистрированныхИзменений;
	ЭлементыФормы.ДеревоТаблиц.Колонки.КоличествоНевыгруженных.Видимость = ВычислятьЧислоЗарегистрированныхИзменений;
	Возврат ТекстУзлов;

КонецФункции

Процедура ИтогиТаблицыПоУзламПриАктивизацииСтроки(Элемент)
	
	Если Элемент.ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	УстановитьТекущуюСтрокуТаблицыУзлов(Элемент.ТекущаяСтрока.Узел);
	КП_ТаблицаИзмененийОбновить();
	
КонецПроцедуры

Процедура ОбновитьИтогиПоТаблице(ВыбраннаяСтрока = Неопределено)
	
	Если ВыбраннаяСтрока = Неопределено Тогда
		ВыбраннаяСтрока = ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока;
	КонецЕсли; 
	Для Каждого СтрокаУзла Из ИтогиТаблицыПоУзлам Цикл
		СтрокаУзла.КоличествоЗарегистрированных = 0;
		СтрокаУзла.КоличествоНевыгруженных = 0;
		СтрокаУзла.КоличествоВыгруженных = 0;
	КонецЦикла; 
	Если Истина
		И ВыбраннаяСтрока <> Неопределено
		И ВыбраннаяСтрока.Уровень() = 1
		И мДанныеПоКоличествуИзменений <> Неопределено 
	Тогда
		ирКлиент.ОбновитьСтатистикуПоТаблицеОбъектаМДВРезультатеПакетаЛкс(мДанныеПоКоличествуИзменений, ВыбраннаяСтрока.ПолноеИмя, "ПолноеИмя", "КоличествоЗарегистрированных", Истина, 
				Новый Структура("Узел", Узлы.ВыгрузитьКолонку("Ссылка")));
		Для Каждого ТаблицаРезультата Из мДанныеПоКоличествуИзменений Цикл
			Для Каждого СтрокаРезультата Из ТаблицаРезультата.НайтиСтроки(Новый Структура("ПолноеИмя", ВыбраннаяСтрока.ПолноеИмя)) Цикл
				СтрокаУзла = ИтогиТаблицыПоУзлам.Найти(СтрокаРезультата.Узел, "Узел");
				Если СтрокаУзла = Неопределено Тогда
					Продолжить;
				КонецЕсли; 
				СтрокаУзла.КоличествоЗарегистрированных = СтрокаУзла.КоличествоЗарегистрированных + СтрокаРезультата.КоличествоЗарегистрированных;
				СтрокаУзла.КоличествоНевыгруженных = СтрокаУзла.КоличествоНевыгруженных + СтрокаРезультата.КоличествоНевыгруженных;
				СтрокаУзла.КоличествоВыгруженных = СтрокаУзла.КоличествоВыгруженных + СтрокаРезультата.КоличествоВыгруженных;
				СтрокаУзла = ИтогиТаблицыПоУзлам.Найти("<Все>", "Узел");
				СтрокаУзла.КоличествоЗарегистрированных = СтрокаУзла.КоличествоЗарегистрированных + СтрокаРезультата.КоличествоЗарегистрированных;
				СтрокаУзла.КоличествоНевыгруженных = СтрокаУзла.КоличествоНевыгруженных + СтрокаРезультата.КоличествоНевыгруженных;
				СтрокаУзла.КоличествоВыгруженных = СтрокаУзла.КоличествоВыгруженных + СтрокаРезультата.КоличествоВыгруженных;
			КонецЦикла;
		КонецЦикла; 
		ОбновитьКоличествоДляСтрокиДерева(ВыбраннаяСтрока);
	КонецЕсли;
	ОбновитьИтогиПоУзлам();

КонецПроцедуры

Процедура ТаблицаИзмененийПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если ЭлементыФормы.ИтогиТаблицыПоУзлам.ТекущаяСтрока <> Неопределено Тогда
		лУзел = ЭлементыФормы.ИтогиТаблицыПоУзлам.ТекущаяСтрока.Узел;
		Если ТипЗнч(лУзел) <> Тип("Строка") Тогда
			//Если Элемент.Колонки.Найти("Узел") <> Неопределено Тогда
				Элемент.ТекущиеДанные.Узел = лУзел;
			//КонецЕсли; 
		КонецЕсли; 
	КонецЕсли; 
	
КонецПроцедуры

Процедура КоманднаяПанельДереваОбъектовОткрытьОбработкуОбъектов(Кнопка)
	
	Если ЭлементыФормы.ДеревоТаблиц.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	ОбработкаОбъектов = ирОбщий.СоздатьОбъектПоИмениМетаданныхЛкс("Обработка.ирПодборИОбработкаОбъектов");
	#Если Сервер И Не Сервер Тогда
	    ОбработкаОбъектов = Обработки.ирПодборИОбработкаОбъектов.Создать();
	#КонецЕсли
	ФормаОбработки = ОбработкаОбъектов.ПолучитьФорму();
	ФормаОбработки.Открыть();
	ОбработкаОбъектов.ИспользоватьОтборПоУзлу = Истина;
	Если ЭлементыФормы.Узлы.ТекущаяСтрока <> Неопределено Тогда
		ОбработкаОбъектов.УзелОтбораОбъектов = ЭлементыФормы.Узлы.ТекущаяСтрока.Ссылка;
	ИначеЕсли ЗначениеЗаполнено(ИмяПланОбмена) Тогда 
		ОбработкаОбъектов.УзелОтбораОбъектов = Новый ("ПланОбменаСсылка." + ИмяПланОбмена);
	КонецЕсли; 
	ПолныеИменаТаблиц = ПолучитьПолныеИменаВыделенныхТаблиц();
	Если ПолныеИменаТаблиц.Количество() = 1 Тогда
		ОбластьПоиска = ПолныеИменаТаблиц[0].Значение;
	Иначе
		ОбластьПоиска = ПолныеИменаТаблиц;
	КонецЕсли; 
	ФормаОбработки.УстановитьОбластьПоиска(ОбластьПоиска);
	
КонецПроцедуры

Процедура КПУзлыВыгрузкаДанныхЧерезФайл(Кнопка)
	
	Если ЭлементыФормы.Узлы.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	ОбработкаОбъектов = ирОбщий.СоздатьОбъектПоИмениМетаданныхЛкс("Обработка.ирВыгрузкаЗагрузкаДанныхЧерезФайл");
	#Если Сервер И Не Сервер Тогда
	    ОбработкаОбъектов = Обработки.ирВыгрузкаЗагрузкаДанныхЧерезФайл.Создать();
	#КонецЕсли
	ФормаОбработки = ОбработкаОбъектов.ПолучитьФорму();
	ФормаОбработки.Открыть();
	ОбработкаОбъектов.УзелВыборкиДанных = ЭлементыФормы.Узлы.ТекущаяСтрока.Ссылка;
	
КонецПроцедуры

Процедура КоманднаяПанельДереваОбъектовСверткаСодержимое(Кнопка)
	
	ИзменитьСвернутостьПанельТекущейТаблицы(Не ПоказыватьСодержимое);
	Если ПоказыватьСодержимое Тогда
		КП_ТаблицаИзмененийОбновить();
	КонецЕсли; 

КонецПроцедуры

Процедура ИзменитьСвернутостьПанельТекущейТаблицы(Видимость)
	
	ирКлиент.ИзменитьСвернутостьЛкс(ЭтаФорма, Видимость, ЭлементыФормы.ПанельТекущейТаблицы, ЭтаФорма.ЭлементыФормы.РазделительГоризонтальный, ЭтаФорма.Панель, "низ");
	ЭлементыФормы.КоманднаяПанельДереваОбъектов.Кнопки.СверткаСодержимое.Пометка = Видимость;
	ЭтаФорма.ПоказыватьСодержимое = Видимость;

КонецПроцедуры

Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	Если Не Отказ Тогда
		ИзменитьСвернутостьПанельТекущейТаблицы(Истина);
	КонецЕсли; 

КонецПроцедуры

Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник) Экспорт
	
	ирКлиент.Форма_ОбработкаОповещенияЛкс(ЭтаФорма, ИмяСобытия, Параметр, Источник); 

КонецПроцедуры

Процедура КП_ТаблицаИзмененийКонсольОбработки(Кнопка)
	
	ТекущаяСтрока = ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Или ТекущаяСтрока.Уровень() = 0 Тогда
		Возврат;
	КонецЕсли; 
	ирКлиент.ОткрытьОбъектыИзВыделенныхЯчеекВПодбореИОбработкеОбъектовЛкс(ЭлементыФормы.ТаблицаИзменений,, ЭтаФорма, ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока.ПолноеИмя);

КонецПроцедуры

Процедура ОсновныеДействияФормыКопироватьРегистрациюВсехОбъектов(Кнопка)
	
	Если ЭлементыФормы.Узлы.ТекущаяСтрока = Неопределено Тогда
		Предупреждение("Сначала необходимо выбрать узел");
		Возврат;
	КонецЕсли; 
	ФормаВыбора = ПолучитьФорму("ВыборУзловПриемниковДляКопирования", ЭтаФорма);
	ФормаВыбора.Узлы = Узлы.Скопировать(Новый Структура("СобственныйУзел", Ложь));
	ФормаВыбора.УзелИсточник = ЭлементыФормы.Узлы.ТекущаяСтрока.Ссылка;
	РезультатФормы = ФормаВыбора.ОткрытьМодально();
	Если РезультатФормы <> Неопределено Тогда
		ЗаказатьОбновлениеДереваПослеИзмененияРегистрации();
	КонецЕсли; 
	
КонецПроцедуры

Процедура КПУзлыРедактироватьОбъект(Кнопка)
	
	Если ЭлементыФормы.Узлы.ТекущаяСтрока <> Неопределено Тогда
		ирКлиент.ОткрытьСсылкуВРедактореОбъектаБДЛкс(ЭлементыФормы.Узлы.ТекущаяСтрока.Ссылка);
	КонецЕсли; 
	
КонецПроцедуры

Процедура КоманднаяПанельДереваОбъектовКопироватьРегистрациюОбъектов(Кнопка)
	
	Если ЭлементыФормы.Узлы.ТекущаяСтрока = Неопределено Тогда
		ирОбщий.СообщитьЛкс("Необходимо выбрать узел");
		Возврат;
	КонецЕсли; 
	ПолныеИменаТаблиц = ПолучитьПолныеИменаВыделенныхТаблиц();
	Если ПолныеИменаТаблиц.Количество() = 0 Тогда
		ирОбщий.СообщитьЛкс("Необходимо выделить строки типов");
		Возврат;
	КонецЕсли; 
	ФормаВыбора = ПолучитьФорму("ВыборУзловПриемниковДляКопирования", ЭтаФорма);
	ФормаВыбора.Узлы = Узлы;
	ФормаВыбора.УзелИсточник = ЭлементыФормы.Узлы.ТекущаяСтрока.Ссылка;
	ОбъектыМД = Новый Массив;
	Для Каждого ЭлементСписка Из ПолныеИменаТаблиц Цикл
		ОбъектыМД.Добавить(ирОбщий.ОбъектМДПоПолномуИмениТаблицыБДЛкс(ЭлементСписка.Значение));
	КонецЦикла;
	ФормаВыбора.ОбъектыМД = ОбъектыМД;
	РезультатФормы = ФормаВыбора.ОткрытьМодально();
	Если РезультатФормы <> Неопределено Тогда
		ЗаказатьОбновлениеДереваПослеИзмененияРегистрации();
	КонецЕсли; 
	
КонецПроцедуры

Процедура КП_ТаблицаИзмененийПодборВТаблицуИзменений(Кнопка)
	
	ТекущаяСтрока = ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Или ТекущаяСтрока.Уровень() = 0 Тогда
		Возврат;
	КонецЕсли; 
	Если ТекущаяСтрока.Родитель.Имя = "Константа" Тогда
		//ирКлиент.ОткрытьКонстантуВСпискеЛкс(ТекущаяСтрока.Имя);
	ИначеЕсли ТекущаяСтрока.Родитель.Имя = "Перерасчет" Тогда
		Возврат;
	Иначе
		ОписаниеТипов = Новый ОписаниеТипов(ирОбщий.ЗначенияВМассивЛкс(ирОбщий.ТипОбъектаБДЛкс(мМакетныйОбъект)));
		Если ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока <> Неопределено Тогда
			Если ирОбщий.ЛиКорневойТипСсылкиЛкс(ТекущаяСтрока.Родитель.Имя) Тогда
				КлючОбъекта = ПолучитьКлючОбъектаСтроки(ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока);
			Иначе
				КлючОбъекта = ирОбщий.КлючСтрокиТаблицыБДИзСтрокиТаблицыЗначенийЛкс(ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока.ПолноеИмя, ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока, Истина);
			КонецЕсли; 
		КонецЕсли; 
		ирКлиент.ОткрытьПодборСВыборомТипаЛкс(ЭлементыФормы.ТаблицаИзменений, ОписаниеТипов, КлючОбъекта);
	КонецЕсли; 
	
КонецПроцедуры

Процедура ТаблицаИзмененийОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если ТипЗнч(ВыбранноеЗначение) <> Тип("Массив") Тогда
		Массив = ирОбщий.ЗначенияВМассивЛкс(ВыбранноеЗначение);
	Иначе
		Массив = ВыбранноеЗначение;
	КонецЕсли; 
	Для Каждого ВыбранныйКлюч Из Массив Цикл
		ОбъектРегистрации = ирОбщий.ОбъектДанныхИзСтрокиРезультатаЗапросаЛкс(ВыбранныйКлюч, мМакетныйОбъект, мТекущаяГруппаТипаМетаданных, Ложь);
		УзлыДляРегистрации = ирОбщий.ПолучитьРазрешенныеУзлыДляОбъектаМДЛкс(Метаданные.НайтиПоТипу(ирОбщий.ТипОбъектаБДЛкс(ОбъектРегистрации)), мВыбранныеУзлы);
		ирОбщий.ПланыОбменаИзменитьРегистрациюЛкс(УзлыДляРегистрации, ОбъектРегистрации);
	КонецЦикла;
	КП_ТаблицаИзмененийОбновить();
	
КонецПроцедуры

Процедура КлсКомандаНажатие(Кнопка) Экспорт 
	
	ирКлиент.УниверсальнаяКомандаФормыЛкс(ЭтаФорма, Кнопка);
	
КонецПроцедуры

Процедура ОбработчикОжиданияСПараметрамиЛкс() Экспорт 
	
	ирКлиент.ОбработчикОжиданияСПараметрамиЛкс();

КонецПроцедуры

Процедура ОтображатьТолькоТаблицыСАвторегистрациейПриИзменении(Элемент)
	
	ПостроитьДеревоСоставаПланаОбмена();
	
КонецПроцедуры

Процедура УзлыПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки) Экспорт
	
	ирКлиент.ТабличноеПолеПриВыводеСтрокиЛкс(ЭтаФорма, Элемент, ОформлениеСтроки, ДанныеСтроки);
	Если ДанныеСтроки.СобственныйУзел Тогда
		//ОформлениеСтроки.Ячейки.Пометка.ТолькоПросмотр = Истина;
		ОформлениеСтроки.ЦветФона = WebЦвета.Перламутровый;
		//ЖирныйШрифт = Новый Шрифт(,, Истина);
		//ОформлениеСтроки.Шрифт = ЖирныйШрифт;
	КонецЕсли; 
	
	// Антибаг платформы 8.3.16 Для ссылок планов обмена расширений почему то не отображается представление
	ОформлениеСтроки.Ячейки.Ссылка.УстановитьТекст(ДанныеСтроки.Ссылка);
	

КонецПроцедуры

Процедура КПУзлыОткрытьОбработкуОбъектов(Кнопка)
	
	ирКлиент.ОткрытьОбъектыИзВыделенныхЯчеекВПодбореИОбработкеОбъектовЛкс(ЭлементыФормы.Узлы, "Ссылка");
	
КонецПроцедуры

Процедура УстановитьТекущуюСтрокуТаблицыУзлов(Знач Узел)
	
	СтрокаУзла = Узлы.Найти(Узел, "Ссылка");
	Если СтрокаУзла <> Неопределено Тогда
		ЭлементыФормы.Узлы.ТекущаяСтрока = СтрокаУзла;
		ЭлементыФормы.Узлы.ТекущаяКолонка = ЭлементыФормы.Узлы.Колонки.Ссылка;
	КонецЕсли;

КонецПроцедуры

Процедура ТаблицаИзмененийПриАктивизацииСтроки(Элемент)
	
	ирКлиент.ТабличноеПолеПриАктивизацииСтрокиЛкс(ЭтаФорма, Элемент);

КонецПроцедуры

Процедура КПУзлыНайтиВСписке(Кнопка)
	
	Если ЭлементыФормы.Узлы.ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	ирКлиент.ОткрытьСсылкуВСпискеЛкс(ЭлементыФормы.Узлы.ТекущаяСтрока.Ссылка);
	
КонецПроцедуры

Процедура ПриЗакрытии()
	
	ирКлиент.Форма_ПриЗакрытииЛкс(ЭтаФорма);

КонецПроцедуры

Процедура КоманднаяПанельДереваОбъектовПоказатьСтруктуруХранения(Кнопка)
	
	ТекущаяСтрокаТаблиц = ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрокаТаблиц = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	Форма = ирКлиент.ФормаСтруктурыХраненияТаблицыБДЛкс();
	Форма.ПараметрИмяТаблицы = ТекущаяСтрокаТаблиц.ПолноеИмя + ".Изменения";
	Форма.Открыть();
	
КонецПроцедуры

Процедура КПУзлыПоказатьСтруктуруХранения(Кнопка)
	
	Форма = ирКлиент.ФормаСтруктурыХраненияТаблицыБДЛкс();
	Форма.ПараметрИмяТаблицы = "РегистрацияИзмененийКонфигурации";
	Форма.Открыть();
	
КонецПроцедуры

Процедура ОсновныеДействияФормыГлавныйУзел(Кнопка)
	
	ПолучитьФорму("УправлениеГлавнымУзлом").Открыть();
	
КонецПроцедуры

Процедура КоманднаяПанельДереваОбъектовОткрытьМетаданные(Кнопка)
	
	ТекущаяСтрока = ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	Если ТекущаяСтрока.Уровень() = 1 Тогда
		ирКлиент.ОткрытьОбъектМетаданныхЛкс(ТекущаяСтрока.ПолноеИмя);
	КонецЕсли; 

КонецПроцедуры

Процедура УзлыПометкаПриИзменении(Элемент)
	
	#Если Сервер И Не Сервер Тогда
		ПриИзмененииВыбранныхУзлов();
	#КонецЕсли
	ПодключитьОбработчикОжидания("ПриИзмененииВыбранныхУзлов", 0.1, Истина); // Важно для группового изменения

КонецПроцедуры

Процедура УзлыПриАктивизацииСтроки(Элемент)
	
	ирКлиент.ТабличноеПолеПриАктивизацииСтрокиЛкс(ЭтаФорма, Элемент);

КонецПроцедуры

Процедура ВнешнееСобытие(Источник, Событие, Данные) Экспорт
	
	ирКлиент.Форма_ВнешнееСобытиеЛкс(ЭтаФорма, Источник, Событие, Данные);

КонецПроцедуры

Процедура ТабличноеПолеПриПолученииДанных(Элемент, ОформленияСтрок) Экспорт 
	
	ирКлиент.ТабличноеПолеПриПолученииДанныхЛкс(ЭтаФорма, Элемент, ОформленияСтрок);

КонецПроцедуры

Процедура КП_ТаблицаИзмененийАктивироватьУзел(Кнопка)
	
	Если ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	УстановитьТекущуюСтрокуТаблицыУзлов(ЭлементыФормы.ТаблицаИзменений.ТекущаяСтрока.Узел);
	
КонецПроцедуры

Процедура КПУзлыОбновитьКоличество(Кнопка)
	
	ЗаказатьОбновлениеДереваПослеИзмененияРегистрации();
	
КонецПроцедуры

Процедура КП_ТаблицаИзмененийДинамическийСписок(Кнопка)
	
	Если ирКэш.ЛиПортативныйРежимЛкс() Тогда
		ирОбщий.СообщитьЛкс("Доступно только в непортативных вариантах подсистемы");
		Возврат;
	КонецЕсли;
	ПостроительЗапроса = ПостроительЗапросаДляТаблицыИзменений();
	#Если Сервер И Не Сервер Тогда
		 ПостроительЗапроса = Новый ПостроительЗапроса;
	#КонецЕсли
	ирКлиент.ОткрытьФормуСпискаЛкс(ЭлементыФормы.ДеревоТаблиц.ТекущаяСтрока.ПолноеИмя + ".Изменения",, Истина,,,,,, ПостроительЗапроса.Отбор);
	
КонецПроцедуры

ирКлиент.ИнициироватьФормуЛкс(ЭтаФорма, "Обработка.ирРедакторИзмененийНаУзлах.Форма.Форма");

ДеревоТаблиц.Колонки.Добавить("ПолноеИмя");
ОписаниеТиповПланОбменаСсылка = ирОбщий.ОписаниеТиповПланОбменаСсылкаЛкс();
Узлы.Колонки.Удалить("Ссылка");
Узлы.Колонки.Добавить("Ссылка", ОписаниеТиповПланОбменаСсылка);
мСоответствиеСтрокДереваИМетаданных = Новый Соответствие;
//ВычислятьЧислоЗарегистрированныхИзменений = Истина;
ОтображатьТолькоМетаданныеСИзменениями = Истина;
мВыбранныеУзлы = Новый Массив();
мСоставыПлановОбмена = Новый Структура;
мДлительностьСбораСтатистики = 0;
ПоказыватьСодержимое = Истина;
мВнутреннееИмяТаблицы = "Таблица" + ирОбщий.СуффиксСлужебногоСвойстваЛкс();
мИмяПоляОбъектУдален = "ОбъектУдален" + ирОбщий.СуффиксСлужебногоСвойстваЛкс();
КолонкаШаблон = ЭлементыФормы.ДеревоТаблиц.Колонки.Авторегистрация_Шаблон;
Для Каждого МетаПланОбмена Из Метаданные.ПланыОбмена Цикл
	ИмяКолонки = "Авторегистрация_" + МетаПланОбмена.Имя;
	КолонкаДерева = ДеревоТаблиц.Колонки.Добавить(ИмяКолонки);
	КолонкаТП = ЭлементыФормы.ДеревоТаблиц.Колонки.Добавить(ИмяКолонки);
	ЗаполнитьЗначенияСвойств(КолонкаТП, КолонкаШаблон,, "Имя"); 
	КолонкаТП.Данные = ИмяКолонки;
	КолонкаТП.ТекстШапки = МетаПланОбмена.Имя;
	КолонкаТП.Видимость = Истина;
КонецЦикла;

